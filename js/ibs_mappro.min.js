function IBS_MAPPRO(e){this.run(e)}
(function(e){IBS_MAPPRO.prototype.run=function(f){var d=this;this.options={args:{streetview:!1,maptype:!1,zoom:!1,scroll:!1,drag:!1,admin:!0,controls:!1,list:!1,markerManager:!1,search:!1,elevation:!1,ajax:null,url:null,path:null,liburl:null,libpath:null,nonce:null,sn:1,title:"TWACA",tag:"",div:e("body"),maps:null,debug:"off"},distance:!1,metric:!1,address:"",url:"",markerManager:{set:!1,maxZoom:18,gridSize:50},stroke:{color:"#000fff",weight:5,opacity:.3},followRoad:!0,travelMode:"DRIVING",avoidHighways:!1,
gpx:{routes:!1,tracks:!0,waypoints:!0,placemarks:!0},qtip:{style:"qtip-bootstrap",rounded:!1,shadow:!1}};this.html={};e.extend(this.options.args,f);this.garmin_symbols=this.googlemap=null;this.files={};this.fileId=1E3;this.kml=new KML;this.gpx=new GPX;this.foundPlaces=[];this.siteRoot=function(){return this.options.args.path};this.siteUrl=function(){return this.options.args.url};this.click=function(a){var b=g.sid,c=g.pid;g={pid:null,sid:null};this.setCursor("pointer");b&&(b=this.file.segments[b],
b.pend="extend",b.click(a));c&&this.file.placemarks[c].click(a);this.file.click(a)};var g={pid:null,sid:null};this.setClick=function(a){if(a)return g=a,this.setCursor("crosshair"),!0;this.file.pendReset();g={pid:null,sid:null};this.setCursor("pointer");return!1};this.getClick=function(){return g};this.setCursor=function(a){this.googlemap.setOptions({draggableCursor:a})};this.fitBounds=function(){var a=new google.maps.LatLngBounds;this.file.getBounds(a);this.googlemap.fitBounds(a);this.file.refresh()};
this.setBikeLayer=function(a){this.bicycleLayer&&(a?this.bicycleLayer.setMap(this.googlemap):this.bicycleLayer.setMap(null))};this.setTrafficLayer=function(a){this.trafficLayer&&(a?this.trafficLayer.setMap(this.googlemap):this.trafficLayer.setMap(null))};this.setTransitLayer=function(a){this.transitLayer&&(a?this.transitLayer.setMap(this.googlemap):this.transitLayer.setMap(null))};this.setMenuXY=function(a,b,c,d){"undefined"===typeof c&&(c=0);"undefined"===typeof d&&(d=0);var e=this.html.map_div.width(),
g=this.html.map_div.height(),f=a.width(),h=a.height();b=this.getCanvasXY(b);c=b.x+c;d=b.y+d;a.css({left:e-c<f?c-f:c,top:g-d<h?d-h:d,position:"absolute"})};this.getCanvasXY=function(a){var b=Math.pow(2,this.googlemap.getZoom()),c=new google.maps.LatLng(this.googlemap.getBounds().getNorthEast().lat(),this.googlemap.getBounds().getSouthWest().lng()),c=this.googlemap.getProjection().fromLatLngToPoint(c);a=this.googlemap.getProjection().fromLatLngToPoint(a);return new google.maps.Point(Math.floor((a.x-
c.x)*b),Math.floor((a.y-c.y)*b))};this.measure1=function(){return this.options.metric?"(m)":"(f)"};this.measure2=function(){return this.options.metric?" km":" mi"};this.convertMeters1=function(a){return this.options.metric?a.toFixed(2):(3.2808399*a).toFixed(2)};this.convertMeters2=function(a){return this.options.metric?(a/1E3).toFixed(2):(a/1609.344).toFixed(2)};this.getCkeditorConfig=function(){return{toolbarStartupExpanded:!0,extraPlugins:"filebrowser,imageuploader,image2,print,table",disableNativeSpellChecker:!1,
browserContextMenuOnCtrl:!0,removePlugins:"scayt",removeDialogTabs:"link:upload;image2:Upload",height:200,contentsCss:this.siteUrl()+"/css/map.css",resize_enabled:!0,filebrowserBrowseUrl:this.options.args.ajax+"?action=ibs_mappro_index&func=file&nonce="+this.options.args.nonce,filebrowserImageBrowseUrl:this.options.args.path+"js/ckeditor/plugins/imageuploader/imgbrowser.php/",toolbar:["Source Undo Redo - SelectAll RemoveFormat".split(" "),["Bold","Italic","Underline","Strike"],["Link","Unlink","Image"],
["TextColor","BGColor","Print","Table"]]}};this.removeFile=function(){this.setClick();delete this.file;this.html.placemark_list.empty();this.html.waypoint_list.empty();this.html.segment_list.empty();this.html.file_list.empty();this.setFile()};this.clear=function(a){this.file.clearDialog()};this.isDirty=function(){return this.file&&this.file.dirty?"Changes have not been saved.":null};this.findLocation=function(){};this.showPend=function(a){var b=this.html.pend_info;b.hide();var c=this.getClick(),d=
this.file.pend;c.sid&&(d=this.file.segments[c.sid].pend);switch(d){case "placemark":b.text("Set marker");this.html.list.find(".placemark-list-name").removeClass("img-marker").addClass("img-marker-hot");break;case "segment":b.text("Start route");this.html.list.find(".segment-list-name").removeClass("img-line").addClass("img-line-hot");break;case "sort":b.text("Set sort origin");break;case "extend":b.text("Extend route");break;default:this.html.list.find(".placemark-list-name").removeClass("img-marker-hot").addClass("img-marker");
this.html.list.find(".segment-list-name").removeClass("img-line-hot").addClass("img-line");return}this.setMenuXY(b,a,0,-40);b.show()};this.reset=function(){this.setClick();spin(!1);for(var a in this.file.segments)this.file.segments[a].stopEditing(),this.file.segments[a].cuesheetKill();this.elevationSegment=null;this.sizeHtml()};this.stats=function(a,b,c,d){var f=padLeftStr(d.toString(),3," ")+" placemarks.",g=padLeftStr(c.toString(),3," ")+" segments.";e(a).html("").append(e("<div>").addClass("stats").append(e("<img>").attr("src",
this.siteUrl()+"image/gears.png")).append(e("<span>").html(this.convertMeters2(b)+this.measure2()))).append(e("<div>").addClass("stats").addClass(c?"":"hide").append(e("<img>").attr("src",this.siteUrl()+"image/line.png")).append(e("<span>").html(g))).append(e("<div>").addClass("stats").addClass(d?"":"hide").append(e("<img>").attr("src",this.siteUrl()+"image/marker.png")).append(e("<span>").html(f)))};this.alert=function(a){a=jQuery("<div>").attr({id:"alert-dialog",title:"Alert"}).css({"background-color":"Tomato",
color:"white"}).append(jQuery("<p>").append(jQuery("<img>").attr("src",this.siteUrl()+"image/alert-white.png").css({"float":"left","margin-right":"5px"})).append(jQuery("<span>").html(a)));jQuery(a).dialog({autoOpen:!0,modal:!0,buttons:{Ok:function(){jQuery(this).dialog("close")}},close:function(){jQuery(this).dialog("destroy")}})};this.confirm=function(a,b){var c=jQuery("<div>").attr({id:"alert-dialog",title:"Confirm"}).css({"background-color":"Tomato",color:"white"}).append(jQuery("<p>").append(jQuery("<img>").attr("src",
this.siteUrl()+"image/alert-white.png").css({"float":"left","margin-right":"5px"})).append(jQuery("<span>").html(a)));jQuery(c).dialog({autoOpen:!0,modal:!0,buttons:{Ok:function(){jQuery(this).dialog("close");b(!0)},Cancel:function(){jQuery(this).dialog("close");b(!1)}},close:function(){jQuery(this).dialog("destroy")}})};this.prompt=function(a,b){var c=d.html.prompt_dialog;c.dialog({autoOpen:!0,modal:!0,buttons:{Ok:function(){c.dialog("close");"function"===typeof b&&b(c.find(".answer").val())},Cancel:function(){c.dialog("close");
"function"===typeof b&&b(null)}},close:function(){c.dialog("destroy")}})};this.notice=function(a){var b=jQuery("<div>").attr({id:"notice-dialog",title:"Notice"}).css({"background-color":"white",color:"black"}).append(jQuery("<p>").append(jQuery("<img>").attr("src",this.siteUrl()+"image/info.png").css({"float":"left","margin-right":"5px"})).append(jQuery("<span>").html(a)));jQuery(b).dialog({autoOpen:!0,modal:!1,show:{effect:"blind",duration:1E3},hide:{effect:"blind",duration:1E3},open:function(){var a=
window.setInterval(function(){try{jQuery(b).dialog("close")}catch(d){}window.clearInterval(a)},2500)},close:function(){jQuery(this).dialog("destroy")}})};this.setIcons=function(){this.imageSegmentEnd=new google.maps.MarkerImage(this.siteUrl()+"image/blue_box.png",new google.maps.Size(16,16),new google.maps.Point(0,0),new google.maps.Point(8,8));this.imagePlacemark=new google.maps.MarkerImage(this.siteUrl()+"image/blue.png",new google.maps.Size(32,32),new google.maps.Point(0,0),new google.maps.Point(16,
33),new google.maps.Size(32,32));this.imageDistancePointer=new google.maps.MarkerImage(this.siteUrl()+"image/crosshair-black.png",new google.maps.Size(16,16),new google.maps.Point(0,0),new google.maps.Point(8,8));this.imageBlueMarker=new google.maps.MarkerImage(this.siteUrl()+"image/blue.png",new google.maps.Size(32,32),new google.maps.Point(0,0),new google.maps.Point(16,33),new google.maps.Size(32,32));this.imageRedMarker=new google.maps.MarkerImage(this.siteUrl()+"image/pink.png",new google.maps.Size(32,
32),new google.maps.Point(0,0),new google.maps.Point(16,33),new google.maps.Size(32,32));this.imageLineActive=new google.maps.MarkerImage(this.siteUrl()+"image/redCircle.png",new google.maps.Size(16,16),new google.maps.Point(0,0),new google.maps.Point(8,8));this.imageLineNormal=new google.maps.MarkerImage(this.siteUrl()+"image/blue_box.png",new google.maps.Size(16,16),new google.maps.Point(0,0),new google.maps.Point(8,8));this.imageWaypointNormal=new google.maps.MarkerImage(this.siteUrl()+"image/waypoint.png",
new google.maps.Size(32,32),new google.maps.Point(0,0),new google.maps.Point(15,25));this.imageNormal=new google.maps.MarkerImage(this.siteUrl()+"image/square.png",new google.maps.Size(11,11),new google.maps.Point(0,0),new google.maps.Point(6,6));this.imageHover=new google.maps.MarkerImage(this.siteUrl()+"image/square_over.png",new google.maps.Size(11,11),new google.maps.Point(0,0),new google.maps.Point(6,6));this.imageNormalMidpoint=new google.maps.MarkerImage(this.siteUrl()+"image/square_transparent.png",
new google.maps.Size(11,11),new google.maps.Point(0,0),new google.maps.Point(6,6));e.getJSON(this.options.args.ajax,{action:"ibs_mappro_index",func:"icons",lib:this.options.args.libpath+"icons/garmin/",nonce:this.options.args.nonce}).done(function(a){d.garmin_symbols=a})};this.getIcon16=function(a){return new google.maps.MarkerImage(a,new google.maps.Size(16,16),new google.maps.Point(0,0),new google.maps.Point(8,8))};this.getIcon32=function(a){return new google.maps.MarkerImage(a,new google.maps.Size(32,
37),new google.maps.Point(0,0),new google.maps.Point(16,37))};this.getIcon=function(a){return-1!==a.indexOf("-lv")?this.getIcon16(a):this.getIcon32(a)};this.getSymbol=function(a){for(var b=0;b<this.garmin_symbols.length;b++)if(a===this.garmin_symbols[b].url)return this.garmin_symbols[b].name;return"icon61"===getFilename(a)?"Waypoint":initialCaps(getFilename(a).replace("-"," ").replace("_"," "))};this.getUrlFromSymbol=function(a){if("Waypoint"===a)return d.options.args.url+"image/waypoint.png";var b=
this.imagePlacemark.url;if(""!==a){a=a.toLowerCase();var c=a.split(" ");1<c.length&&(c[1]=c[1].replace("(","").replace(")",""),a=c[0]+"-"+c[1]);for(c=0;c<this.garmin_symbols.length;c++)if(a===this.garmin_symbols[c].name)return this.garmin_symbols[c].url}return b};this.setFile=function(){this.file=new File(this,{url:"",stroke:this.options.stroke,filename:this.options.filename,gpx:this.options.gpx})};this.setMap=function(){for(var a in this.options.map_types)this.options.map_types[a].set&&this.options.mapTypeControlOptions.mapTypeIds.push(this.options.map_types[a].type);
var b=[],c;for(c in google.maps.MapTypeId)b.push(google.maps.MapTypeId[c]);b.push("OSM");b.push("OSMCYCLE");b.push("OSMPUBLIC");b.push("OSMLANDSCAPE");b.push("OSMOUTDOORS");b={center:new google.maps.LatLng(37.09024,-95.712891),disableDefaultUI:!1,disableDoubleClickZoom:!0,draggable:this.options.args.drag,draggableCursor:"auto",draggingCursor:"auto",heading:0,keyboardShortcuts:!0,mapTypeControl:this.options.args.maptype,mapTypeControlOptions:{mapTypeIds:b,position:google.maps.ControlPosition.TOP_RIGHT,
style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},mapTypeId:this.options.mapTypeId,scrollwheel:this.options.args.admin||this.options.args.scroll,streetViewControl:this.options.args.streetview,streetViewControlOptions:{position:google.maps.ControlPosition.TOP_LEFT},scaleControl:!1,zoom:7,zoomControl:this.options.args.zoom,zoomControlOptions:{position:google.maps.ControlPosition.TOP_LEFT,style:google.maps.ZoomControlStyle.SMALL}};this.googlemap=new google.maps.Map(e("#map-div-"+this.options.args.sn)[0],
b);b=[{set:"on",name:"OSM street",type:"OSM",size:{x:256,y:256},zoom:18,url:"http://tile.openstreetmap.org/"},{set:"on",name:"OSM Cycle",type:"OSMCYCLE",size:{x:256,y:256},zoom:18,url:"http://tile.thunderforest.com/cycle/"},{set:"on",name:"OSM Transport",type:"OSMTRANSPORT",size:{x:256,y:256},zoom:18,url:"http://tile.thunderforest.com/transport/"},{set:"on",name:"OSM Landscape",type:"OSMLANDSCAPE",size:{x:256,y:256},zoom:18,url:"http://tile.thunderforest.com/landscape/"},{set:"on",name:"OSM Outdoors",
type:"OSMOUTDOORS",size:{x:256,y:256},zoom:18,url:"http://tile.thunderforest.com/outdoors/"}];for(a in b)if(c=b[a],c.set){var f=new google.maps.ImageMapType({getTileUrl:function(a,b){return this.url+b+"/"+a.x+"/"+a.y+".png"},tileSize:new google.maps.Size(parseInt(c.size.x),parseInt(c.size.y)),name:c.name,maxZoom:parseInt(c.maxZoom),url:c.url});this.googlemap.mapTypes.set(c.type,f)}this.bicycleLayer=new google.maps.BicyclingLayer;this.trafficLayer=new google.maps.TrafficLayer;this.transitLayer=new google.maps.TransitLayer;
this.directionsService=new google.maps.DirectionsService;this.geocoder=new google.maps.Geocoder;this.placesService=new google.maps.places.PlacesService(d.googlemap);this.options.args.admin&&(d.googlemap.controls[google.maps.ControlPosition.TOP_LEFT].push(this.html.action_menu[0]),d.googlemap.controls[google.maps.ControlPosition.TOP_LEFT].push(this.html.draw_menu[0]),this.html.action_menu.show(),this.html.draw_menu.show());if(this.options.args.admin||this.options.args.controls)d.googlemap.controls[google.maps.ControlPosition.TOP_LEFT].push(this.html.control_menu[0]),
this.html.control_menu.show();if("undefined"!==typeof this.options.args.wpadmin||!0===this.options.args.wpadmin)d.googlemap.controls[google.maps.ControlPosition.TOP_LEFT].push(this.html.manage_menu[0]),this.html.manage_menu.show();if(d.options.args.admin||d.options.args.search)this.searchBox=new google.maps.places.SearchBox(d.html.search_box.find(".ibs-pac-input")[0]),this.searchBox.setBounds(d.googlemap.getBounds()),d.googlemap.controls[google.maps.ControlPosition.TOP_LEFT].push(d.html.search_box[0]),
d.googlemap.addListener("bounds_changed",function(){d.searchBox.setBounds(d.googlemap.getBounds())}),this.searchBox.addListener("places_changed",function(){d.searchPlaces(d)});this.infowindow=new google.maps.InfoWindow({content:""});this.searchmarker=new google.maps.Marker({position:new google.maps.LatLng(37.09024,-95.712891),map:this.googlemap,visible:!1,title:"search marker",icon:this.imageRedMarker})};this.postGoogleLoad=function(){this.setFile();google.maps.event.addListener(this.searchmarker,
"click",function(a){this.setVisible(!1)});google.maps.event.addListener(this.googlemap,"click",e.proxy(function(a){this.click(a)},this));google.maps.event.addListener(this.googlemap,"rightclick",e.proxy(function(a){this.setClick()},this));google.maps.event.addListener(this.googlemap,"mousemove",e.proxy(function(a){this.showPend(a.latLng)},this));google.maps.event.addListener(this.googlemap,"drag",function(a){try{if("object"===typeof d.html.route_menu&&d.html.route_menu.is(":visible")){var b=d.html.route_menu.find(".ibs-route-item").first().attr("rel"),
c=d.file.segments[b].marker.getPosition();d.setMenuXY(d.html.route_menu,c)}}catch(e){}});this.options.args.maps&&(this.options.args.maps=this.options.args.maps.replace("%maps%;",d.options.args.liburl+"maps/"));isUrl(this.options.args.maps)?this.file.importFile(this.options.args.maps):""!==this.options.address&&this.geocoder.geocode({address:this.options.address},e.proxy(function(a,b){if(b===google.maps.GeocoderStatus.OK){var c=a[0].geometry.location.lat(),d=a[0].geometry.location.lng(),d=parseFloat(d),
c=parseFloat(c);"number"===typeof c&&"number"===typeof d&&(c=new google.maps.LatLng(c,d),this.googlemap.setCenter(c))}},this));google.maps.event.addListenerOnce(d.googlemap,"tilesloaded",function(){google.maps.event.addListenerOnce(d.googlemap,"tilesloaded",function(){google.maps.event.trigger(d.googlemap,"resize")})});google.maps.event.addListenerOnce(d.googlemap,"zoom_changed",function(){setTimeout(function(){var a=d.googlemap.getCenter();a.e+=1E-6;d.googlemap.panTo(a);a.e-=1E-6;d.googlemap.panTo(a);
a=parseInt(d.options.args.sn)+1;e("#ibs-map-"+a+"-trigger").trigger("click")},400)})};this.initMap=function(){this.htmlGen(this);this.options.args.admin||this.html.page.find(".ibs-admin-only").hide();this.setHandlers(this);this.sizeHtml();this.setIcons();this.setMap();google.maps.event.addListenerOnce(this.googlemap,"idle",e.proxy(function(a){this.postGoogleLoad()},this))};"1"===f.sn?(e("#ibs-map-"+f.sn+"-trigger").remove(),this.initMap(),d.html.list.find('a[rel="list-poi"]').click()):e("#ibs-map-"+
f.sn+"-trigger").click(e.proxy(function(){e("#ibs-map-"+f.sn+"-trigger").remove();this.initMap();d.html.list.find('a[rel="list-poi"]').click()},this));this.browseDialog=function(){var a=this.html.browse_dialog;a.dialog({autoOpen:!0,width:600,modal:!0,buttons:{Select:e.proxy(function(){var b="";a.find("a.selected").each(function(){c=e(this).attr("rel");b+=e(this).text()+";"});if(""!==b){var c=c.replace(d.options.args.libpath,d.options.args.liburl),f=purl(c),c=f.data.attr.base+f.data.attr.directory,
b=c+b.slice(0,b.length-1);this.file.importFile(b)}a.dialog("close")},this),Close:function(){e(this).dialog("close")}},close:function(){e(this).dialog("destroy")},open:e.proxy(function(){var b=d.options.args.admin?d.options.args.libpath+"maps/":d.options.args.libpath+"maps/ACA";a.find(".ibs-map-browser").fileTree({root:b,script:d.options.args.ajax+"?action=ibs_mappro_index&func=folders&type=map&nonce="+d.options.args.nonce,folderEvent:"click",expandSpeed:0,collapseSpeed:0,multiFolder:!1},function(a){},
function(a){})},this)})}}})(jQuery);
