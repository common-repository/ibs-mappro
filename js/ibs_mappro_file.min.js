function File(d,b){this.run(d,b)}
(function(d){File.prototype.run=function(b,l){this.options={filename:"(%un-named%).kml",name:null,desc:null,stroke:{color:"#000fff",weight:5,opacity:.3},gpx:{routes:!1,tracks:!0,waypoints:!0,placemarks:!0},import_dir:null,import_files:[]};for(var m in l)"undefined"!==typeof l[m]&&(this.options[m]=l[m]);this.fileCount=0;this.markerCluster=[];this.markerManager=null;this.visibleWaypoint=this.visiblePlacemark=!1;this.dir="/";this.filename=this.options.filename;this.options.name=this.filename;b.html.segment_list.sortable();
b.html.segment_list.disableSelection();b.html.placemark_list.sortable();b.html.placemark_list.disableSelection();b.html.waypoint_list.sortable();b.html.waypoint_list.disableSelection();this.segments={};this.placemarks={};this.fileId=this.placemarkId=this.segmentId=1E3;this.removeFile=!1;this.pend=null;this.included=[];this.newComponents=null;this.setDirty=function(a){this.dirty=a};this.checkMapname=function(a,b){if("string"===typeof a&&3<a.length){var c=getExtension(a),d=getFilename(a);if(/^[\w\s-()]{3,50}$/.test(d)){if("kml"!==
c||"kmz"!==c||"gpx"!==c)c=b;return d+"."+c}}return!1};this.listSegments=function(){var a=[],e=b.html.segment_list.find("li a.ibs-segment-item-name");d(e).each(function(e,g){var f=d(g).attr("rel");-1!==d.inArray(b.file.segments[f].options.fid,b.file.included)&&a.push(f)});return a};this.listPlacemarks=function(){var a=[],e=b.html.placemark_list.find("li a.ibs-placemark-item-name");d(e).each(function(e,g){var f=d(g).attr("rel");-1!==d.inArray(b.file.placemarks[f].options.fid,b.file.included)&&a.push(f)});
e=b.html.waypoint_list.find("li a.ibs-placemark-item-name");d(e).each(function(e,g){var f=d(g).attr("rel");-1!==d.inArray(b.file.placemarks[f].options.fid,b.file.included)&&a.push(f)});return a};this.sortSegments=function(a){var b=a.latLng;a=[];for(var c in this.segments){var g={distance:distanceFrom(b,this.segments[c].marker.getPosition()),sid:c};a.push(g)}a.sort(function(a,b){return a.distance<b.distance?-1:a.distance>b.distance?1:0});c=null;for(var f in a)c&&(c="."+c,d("."+a[f].sid).insertAfter(c)),
c=a[f].sid};this.sortPlacemarks=function(a){var b=a.latLng;a=[];for(var c in this.placemarks){var g={distance:distanceFrom(b,this.placemarks[c].marker.getPosition()),pid:c};a.push(g)}a.sort(function(a,b){return a.distance<b.distance?-1:a.distance>b.distance?1:0});c=null;for(var f in a)c&&(c="."+c,d("."+a[f].pid).insertAfter(c)),c=a[f].pid};this._orderPlacemark=function(a){var b=null,c=null,g;for(g in this.placemarks)if(g!==a){var f=distanceFrom(this.placemarks[a].marker.getPosition(),this.placemarks[g].marker.getPosition());
if(!b||f<b)b=f,c=g}c&&(b="#"+c,d("#"+a).insertAfter(b))};this._add=function(){this.newComponents||(this.fileId++,this.newComponents=this.fileId,this.setFileItem("(%new%).kml"))};this._addSegment=function(a){var e={fid:null,sid:null,path:[],stroke:{color:"#000fff",weight:5,opacity:.3},name:null,desc:null};d.extend(e,a);a=e;for(var c in this.segments)if(this.segments[c].options.name===a.name){this.segments[c].line.setPath(a.path);return}this.segmentId++;a.sid="S"+this.segmentId.toString();a.fid||(a.fid=
"F"+this.fileId);a.name||(a.name=a.sid+" name");this.segments[a.sid]=new Segment(b,a);return a.sid};this.addSegment=function(a){this._add();this.segments[this._addSegment(a)].extend();this.setDirty(!0)};this._addPlacemark=function(a){var e={fid:null,pid:null,name:null,desc:null,url:null,symbol:null,position:null,visible:!0};d.extend(e,a);a=e;this.placemarkId++;a.pid="P"+this.placemarkId.toString();a.fid||(a.fid="F"+this.fileId);a.name||(a.name=a.pid+" name");this.placemarks[a.pid]=new Placemark(b,
a);e="Waypoint"===this.placemarks[a.pid].options.symbol?d("#dropdown-controls-"+b.options.args.sn).find(".control-waypoints").is(":checked"):d("#dropdown-controls-"+b.options.args.sn).find(".control-placemarks").is(":checked");this.placemarks[a.pid].marker.setVisible(e);return a.pid};this.addPlacemark=function(a){this._add();a=this._addPlacemark(a);this.placemarks[a].marker.setVisible(!0);this.setDirty(!0);this._orderPlacemark(a);return a};this.click=function(a){if(this.pend){switch(this.pend){case "sort":this.sortPlacemarks(a);
this.sortSegments(a);break;case "placemark":this.addPlacemark({position:a.latLng});this.pendReset();break;case "segment":this.addSegment({path:[a.latLng],strokeColor:this.options.stroke})}this.pend=null}};this.pendReset=function(){b.html.pend_info.hide();for(var a in this.segments)this.segments[a].pend="";this.pend=null};this.pendSegment=function(){"segment"===this.pend?(b.setClick(),b.html.pend_info.hide()):(b.setClick({sid:null,pid:null}),this.pend="segment",b.showPend(b.googlemap.getCenter()))};
this.pendSort=function(){b.setClick({sid:null,pid:null});this.pend="sort";b.showPend(b.googlemap.getCenter())};this.pendPlacemark=function(){"placemark"===this.pend?b.setClick():(b.setClick({sid:null,pid:null}),this.pend="placemark",b.showPend(b.googlemap.getCenter()))};this.placemarkVisible=function(a){this.visiblePlacemark=a;for(var e in this.placemarks){var c=this.placemarks[e];"Waypoint"===c.options.symbol?c.marker.setVisible(d("#dropdown-controls-"+b.options.args.sn).find(".control-waypoints").is(":checked")):
c.marker.setVisible(a)}};this.waypointVisible=function(a){this.visibleWaypoint=a;for(var b in this.placemarks){var c=this.placemarks[b];"Waypoint"===c.options.symbol&&c.marker.setVisible(a)}};this.filteredUrl=null;this.placemarkFilter=function(a){if(null===this.filteredUrl){this.filteredUrl=d(a).attr("src");for(var b in this.placemarks)this.placemarks[b].marker.icon.url===this.filteredUrl?this.placemarks[b].marker.setVisible(!0):this.placemarks[b].marker.setVisible(!1)}else this.filteredUrl===d(a).attr("src")?
(this.filteredUrl=null,this.placemarkVisible(this.visiblePlacemark)):(this.filteredUrl=null,this.placemarkFilter(a))};this.flip=function(){for(var a in this.segments)this.segments[a].flip()};this.distance=function(){var a=0,b;for(b in this.segments)a+=this.segments[b].distance();return a};this.removePlacemark=function(a){this.removeFile||(delete this.placemarks[a],b.html.waypoint_list.find(".ibs-placemark-item-"+a).remove(),b.html.placemark_list.find(".ibs-placemark-item-"+a).remove(),this.setDirty(!0))};
this.removePlacemarks=function(){for(var a in this.placemarks)this.placemarks[a].remove()};this.removeSegment=function(a){this.removeFile||(delete this.segments[a],this.setDirty(!0),b.reset())};this.removeSegments=function(){for(var a in this.segments)this.segments[a].remove()};this.remove=function(){this.removeFile=!0;this.removePlacemarks();this.removeSegments();b.html.file_list.empty();this.markerManager&&this.markerManager.clearMarkers();b.removeFile()};this.getBounds=function(a){for(var b in this.segments)this.segments[b].getBounds(a);
for(var c in this.placemarks)a.extend(this.placemarks[c].marker.getPosition())};this.refresh=function(){for(var a in this.segments)this.segments[a].refresh()};this.isPlacemark=function(a){for(var b in this.placemarks)if(this.placemarks[b].options.position.equals(a))return b;return!1};this.append=function(a){if(1<Object.keys(this.segments).length){var b=null,c=a.line.getPath(),d=c.getAt(c.getLength()-1),f=0,h=0,k;for(k in this.segments)k!==a.sid&&(h=this.segments[k].line.getPath().getAt(0),h=distanceFrom(d,
h),null===b||f>=h)&&(b=this.segments[k],f=h);if(b){for(d=c.getLength()-1;0<=d;d--)f=c.getAt(d),b.line.getPath().insertAt(0,f);a.remove();b.refresh()}else alert("cannot append.")}};this.focus=function(){var a=new google.maps.LatLngBounds;this.getBounds(a);a.isEmpty()||b.googlemap.fitBounds(a)};this.getXml=function(){return"gpx"===getExtension(this.filename)?b.gpx.writer(this):b.kml.writer(this)};this.selectPlacemark=function(a,e){var c=d(a).hasClass("selected");b.html.placemark_list.find(".ibs-placemark-item-name").removeClass("selected");
b.html.waypoint_list.find(".ibs-placemark-item-name").removeClass("selected");!1===c&&(d(a).addClass("selected"),d(a).parent().ScrollTo({onlyIfOutside:!0}),d(a).parent().parent().hasClass("ibs-placemark-list")?b.html.list.find('a[rel="list-poi"]').click():b.html.list.find('a[rel="list-wps"]').click())};this.selectSegmentCheck=function(){return 0<b.html.segment_list.find(".ibs-segment-item-name.selected").length?!0:!1};this.selectSegment=function(a){var e=d(a).hasClass("selected");b.html.segment_list.find(".ibs-segment-item-name").removeClass("selected");
b.html.segment_list.find(".ibs-ct-list-div").hide();!1===e&&(d(a).addClass("selected"),d(a).parent().find(".ibs-ct-list-div").show(),d(a).parent().ScrollTo({onlyIfOutside:!0}),b.html.list.find('a[rel="list-seg"]').click())};this.manageMarkers=function(){this.markerManager&&this.markerManager.clearMarkers();if(b.options.markerManager.set){this.markerCluster=[];for(var a in this.placemarks)this.markerCluster.push(this.placemarks[a].marker);this.markerManager=new MarkerClusterer(b.googlemap,this.markerCluster,
{maxZoom:b.options.markerManager.maxZoom,gridSize:b.options.gridsize})}else for(a in this.placemarks)this.placemarks[a].marker.setMap(b.googlemap)};this.getOptions=function(a){switch(getExtension(this.filename)){case "kml":a.find(".ibs-file-kml").attr("checked",!0);break;case "kmz":a.find(".ibs-file-kmz").attr("checked",!0);break;case "gpx":a.find(".ibs-file-gpx").attr("checked",!0);break;default:a.find(".ibs-file-kml").attr("checked",!0)}a.find(".ibs-gpx_routes").attr("checked",this.options.gpx.routes);
a.find(".ibs-gpx_tgracks").attr("checked",this.options.gpx.tracks);a.find(".ibs-gpx_waypoints").attr("checked",this.options.gpx.waypoints);a.find(".ibs-gpx_placemarks").attr("checked",this.options.gpx.placemarks);a.find(".ibs-file-list-div").empty().append(b.html.file_list.clone());a.find(".ibs-file-item-checkbox")};this.setOptions=function(a){this.options.gpx.routes=a.find(".ibs-gpx_routes").is(":checked");this.options.gpx.tracks=a.find(".ibs-gpx_tracks").is(":checked");this.options.gpx.waypoints=
a.find(".ibs-gpx_waypoints").is(":checked");this.options.gpx.placemarks=a.find(".ibs-gpx_placemarks").is(":checked");this.included=[];a.find(".ibs-file-item-checkbox").each(function(a,c){d(c).is(":checked")&&b.file.included.push(d(c).attr("rel"))})};this.saveDialog=function(){var a=b.html.save_dialog,e=b.getCkeditorConfig();this.getOptions(a);a.find(".ibs-save-name").val(a.find(".ibs-name-of-file").first().text());a.find(".ibs-save-dir").val(a.find(".ibs-name-of-file").first().attr("rel"));a.find(".ibs-save-desc").val(this.options.desc);
a.dialog({autoOpen:!0,modal:!0,width:"auto",buttons:{Save:d.proxy(function(){if(this.checkMapname(a.find(".ibs-save-name").val())){this.options.desc=a.find(".ibs-save-desc").val();this.dir=a.find(".ibs-save-dir").val();this.filename=a.find(".ibs-save-name").val();this.setOptions(a);a.dialog("close");var c=this.getXml();c?d.post(b.options.args.ajax,{action:"ibs_mappro_index",func:"savexml",nonce:b.options.args.nonce,data:encodeURIComponent(c),filename:b.options.args.libpath+"maps/"+this.dir+this.filename}).done(function(a,
c){spin(!1);"success"===c?(b.file.setDirty(!1),b.notice("Save "+b.file.filename+" completed.")):b.alert("Save "+b.file.filename+" failed.")}):b.alert("Error creating XML document.")}else b.alert('invalid filename.\n Only "A-Z a-z 0-9 _ - space" characters are allowed\n 3 - 50 characters long.')},this),Cancel:function(){d(this).dialog("close")}},open:function(){a.find(".ibs-mapfolder-browser").fileTree({root:b.options.args.libpath+"maps/",script:b.options.args.ajax+"?action=ibs_mappro_index&func=folders&type=dir&nonce="+
b.options.args.nonce+"",folderEvent:"click",expandSpeed:0,collapseSpeed:0,multiFolder:!1},function(a){alert(a)},function(b){b=b.split("/maps/");a.find(".ibs-save-dir").val(b[1]).trigger("change")});a.find(".ibs-save-desc").ckeditor(e).resize("100%","100%",!1);a.on("click",".ibs-name-of-file",{},function(){a.find(".ibs-save-name").val(d(this).text())})},close:function(){a.find(".ibs-save-desc").ckeditorGet().destroy();d(this).dialog("destroy")},resize:function(b){a.find(".ibs-save-desc").ckeditor().resize("100%",
"100%",!1)}})};this.downloadDialog=function(){var a=b.html.download_dialog,e=b.getCkeditorConfig();this.getOptions(a);a.find(".ibs-save-name").val(a.find(".ibs-file-list").first(".ibs-name-of-file").text());a.find(".ibs-save-desc").val(this.options.desc);a.dialog({autoOpen:!0,modal:!0,width:"auto",buttons:{Save:d.proxy(function(){if(this.checkMapname(a.find(".ibs-save-name").val())){this.options.desc=a.find(".ibs-save-desc").val();this.dir=a.find(".ibs-save-dir").val();this.filename=a.find(".ibs-save-name").val();
this.setOptions(a);a.dialog("close");var c=this.getXml();c?d.post(b.options.args.ajax,{action:"ibs_mappro_index",func:"savexml",nonce:b.options.args.nonce,data:encodeURIComponent(c),filename:b.options.args.libpath+"downloads/"+this.filename}).done(function(a,c){spin(!1);if("success"===c){b.file.setDirty(!1);var e=d.trim(decodeURIComponent(a));d.fileDownload(b.options.args.ajax+"?action=ibs_mappro_index&func=download&file="+e+"&nonce="+b.options.args.nonce,{successCallback:d.proxy(function(a){b.notice("Download "+
getFilename(a)+" completed.");d.post(b.options.args.ajax,{action:"ibs_mappro_index",func:"remove",nonce:b.options.args.nonce,type:"file",filename:e.replace(b.options.args.liburl,b.options.args.libpath),cache:!1})},this),failCallback:function(a,c){b.alert("File download failed. "+this.filename)}})}else b.alert("Download "+this.filename+" failed.")}):b.alert("Error creating XML document.")}else b.alert('invalid filename.\n Only "A-Z a-z 0-9 _ - space" characters are allowed\n 3 - 50 characters long.')},
this),Cancel:function(){d(this).dialog("close")}},open:function(){a.find(".ibs-save-desc").ckeditor(e).resize("100%","100%",!1)},close:function(){a.find(".ibs-save-desc").ckeditorGet().destroy();a.dialog("destroy")},resize:function(b){a.find(".ibs-save-desc").ckeditor().resize("100%","100%",!1)}})};this.fileDialog=function(){var a=b.html.file_dialog;this.getOptions(a);b.stats(a.find(".ibs-stat-list"),this.distance(),Object.keys(this.segments).length,Object.keys(this.placemarks).length);a.find(".ibs-file-name").val(this.filename);
a.find(".ibs-file-desc").val(this.options.desc);var e=b.getCkeditorConfig();a.colorpicker("stroke",this.options.stroke);a.dialog({autoOpen:!0,modal:!0,width:"auto",buttons:{Update:d.proxy(function(){this.setOptions(a);this.options.stroke=a.colorpicker("stroke");this.setDirty(this.dirty||a.find(".ibs-file-name").val()!==this.filename||a.find(".ibs-file-desc").val()!==this.options.desc);this.filename=a.find(".ibs-file-name").val();this.options.desc=a.find(".ibs-file-desc").val();b.html.list.find(".ibs-list-filename").text(this.filename);
a.dialog("close")},this),Close:function(){d(this).dialog("close")}},open:function(){a.find(".ibs-file-desc").ckeditor(e);a.find(".ibs-file-desc").ckeditor().resize("100%","100%",!1);a.find(".ibs-file-desc").ckeditor().editor.mappro=b;a.on("click",".ibs-name-of-file",{},function(){a.find(".ibs-file-name").val(d(this).text())})},close:function(){a.find(".ibs-file-desc").ckeditorGet().destroy();d(this).dialog("destroy")},resize:function(b){a.find(".ibs-file-desc").ckeditor().resize("100%","100%",!1)}})};
this.clearDialog=function(){var a=b.html.clear_dialog;a.find(".ibs-file-list-div").empty().append(b.html.file_list.clone());a.find(".ibs-file-item-checkbox").prop("checked",!1);a.dialog({autoOpen:!0,modal:!0,width:"auto",buttons:{All:function(){b.file.remove();a.dialog("close")},Selected:d.proxy(function(){this.included=[];a.find(".ibs-file-item-checkbox").each(function(a,c){d(c).is(":checked")&&b.file.included.push(d(c).attr("rel"))});var e=this.listPlacemarks(),c;for(c in e)this.placemarks[e[c]].remove();
e=this.listSegments();for(c in e)this.segments[e[c]].remove();for(c in this.included)"F1000"!==this.included[c]&&b.html.file_list.find(".ibs-file-item-"+this.included[c]).remove();a.dialog("close")},this),Cancel:function(){d(this).dialog("close")}},open:function(){},close:function(){},resize:function(a){}})};this.openInfo=function(a){var e="",c="";if("undefined"===typeof a.options.sid)var d=a.options.pid,c="waypoint"===a.options.symbol?"waypoint":"placemark";else d=a.options.sid,c="segment";switch(c){case "segment":e=
b.html.map.find(".ibs-segment-infowindow");e.find(".ibs-info-name").text(a.options.name);e.find(".ibs-info-desc").html(a.options.desc);e.find(".ibs-info-modify-segment").attr({rel:d});e=e.clone();e.find(".ibs-info-modify-segment").addClass("selected");e.show();break;case "waypoint":case "placemark":e=b.html.map.find(".ibs-placemark-infowindow"),e.find(".ibs-info-name").text(a.options.name),e.find(".ibs-info-desc").html(a.options.desc),e.find(".ibs-info-modify-placemark").attr({rel:d}),e=e.clone(),
e.find(".ibs-info-modify-placemark").addClass("selected"),e.show()}b.infowindow.setContent(e[0]);b.infowindow.open(b.googlemap,a.marker)};this.setFileItem=function(a){var e="F"+this.fileId;try{var c=purl(a),g=c.data.attr.base+c.data.attr.directory,f=c.data.attr.file}catch(h){g="",f=a}g=-1===g.indexOf(b.options.args.liburl+"maps/")?"":g.replace(b.options.args.liburl+"maps/","");a=d("<li>").addClass("file-item-"+e).append(d("<div>").append(d("<input>").attr({type:"checkbox",rel:e}).addClass("ibs-file-item-checkbox").prop("checked",
!0)).append(d("<label>").html(f).addClass("ibs-name-of-file").attr({rel:g})));b.html.file_list.append(a)};this.postLoad=function(){b.options.args.list&&b.options.args.controls||this.placemarkVisible(!0);b.options.markerManager.set=b.options.args.markerManager;this.dirty=!1;b.setClick(null);this.manageMarkers();this.focus()};this._importFile=function(){if(this.options.import_files.length){var a=this.options.import_dir+this.options.import_files.pop();d.post(b.options.args.ajax,{action:"ibs_mappro_index",
func:"CORS",nonce:b.options.args.nonce,path:a,cache:!1}).done(function(e,c){try{if("success"===c){try{var g=d.parseXML(d.trim(e))}catch(f){throw f;}if(0<d(g).find("kml").length)b.file.fileId++,b.kml.reader(g,b.file);else if(0<d(g).find("gpx").length)b.file.fileId++,b.gpx.reader(g,b.file);else{alert("invalid file contents");spin(!1);return}}else throw c;}catch(h){alert("process map failed: "+h);spin(!1);return}-1!==a.indexOf("/mappro/uploads/")&&d.post(b.options.args.ajax,{action:"ibs_mappro_index",
func:"remove",nonce:b.options.args.nonce,type:"file",filename:a.replace(b.options.args.liburl,b.options.args.libpath),cache:!1});b.file.setFileItem(a);b.file.postLoad();b.file._importFile();spin(!1)})}this.tracking()};this.importFile=function(a){this.options.name=null;this.options.desc=null;spin(!0);a=a.replace(/%maps%;/,b.options.libpah+"maps/");a=a.split(";");this.options.import_files=[];for(var e in a)""!==a[e]&&this.options.import_files.push(a[e]);e=purl(this.options.import_files[0]);this.options.import_dir=
e.data.attr.base+e.data.attr.directory;this.options.import_files[0]=e.data.attr.file;this._importFile()};File.prototype.getPids=function(a){var e=a.pop();b.geocoder.geocode({address:e.where},function(c,d){if(d===google.maps.GeocoderStatus.OK){var f=c[0].geometry.location.lat(),h=c[0].geometry.location.lng(),h=parseFloat(h),f=parseFloat(f);"number"===typeof f&&"number"===typeof h&&(f=new google.maps.LatLng(f,h),b.file.placemarks[e.pid].options.position=f,b.file.placemarks[e.pid].options.desc=e.date+
"<br/>"+c[0].formatted_address+"<br/>"+e.msg+"<br/>",b.file.placemarks[e.pid].marker.setPosition(f),b.file.placemarks[e.pid].marker.setVisible(!0));a.length?b.file.getPids(a):(f=new google.maps.LatLngBounds,b.file.getBounds(f),b.googlemap.fitBounds(f))}})};File.prototype.tracking=function(){var a=[];d.getJSON(b.options.args.ajax,{action:"ibs_mappro_index",func:"tracking",nonce:b.options.args.nonce}).done(function(e,c){if("success"===c){for(var d in b.file.placemarks){var f=b.file.placemarks[d].options.name;
"object"===typeof e[f]&&(e[f].pid=d,a.push(e[f]))}0<a.length&&b.file.getPids(a)}})}}})(jQuery);
