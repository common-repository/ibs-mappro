(function(d){IBS_MAPPRO.prototype.setHandlers=function(b){this.html.icon_lib_select.on("change","",{},function(a){d(".ibs-map-icon").qtip("destroy",!0);b.html.icon_library_list.empty();d.getJSON(b.options.args.ajax,{action:"ibs_mappro_index",func:"icons",nonce:b.options.args.nonce,lib:b.options.args.libpath+"icons/"+b.html.icon_lib_select.val()}).done(function(a){for(var e in a)b.html.icon_library_list.append('<img class="ibs-map-icon" src="'+a[e].url+'" title="'+a[e].name+'" width="32" height="32" />');
d(".ibs-map-icon").qtip({surpress:!0,position:{my:"top left",at:"bottom right"},style:{classes:b.options.qtip.style+" "+b.options.qtip.rounded+b.options.qtip.shadow},show:{event:"mouseover"},hide:{fixed:!0,delay:250,event:"mouseout mouseleave"}})})});b.html.list_tabs.on("click",".ibs-list-tab a",function(a){a.preventDefault();b.html.list_tabs.find(".ibs-list-tab a").removeClass("selected");switch(d(this).attr("rel")){case "list-left":b.html.list_tabs.find(".ibs-list-right").show();b.html.list_tabs.find(".ibs-list-left").hide();
b.html.list.css({float:"left"});break;case "list-right":b.html.list_tabs.find(".ibs-list-right").hide();b.html.list_tabs.find(".ibs-list-left").show();b.html.list.css({float:"right"});break;case "list-poi":d(this).addClass("selected");b.html.list.find(".ibs-list-seg").hide();b.html.list.find(".ibs-list-wps").hide();b.html.list.find(".ibs-list-poi").show();break;case "list-seg":d(this).addClass("selected");b.html.list.find(".ibs-list-poi").hide();b.html.list.find(".ibs-list-wps").hide();b.html.list.find(".ibs-list-seg").show();
break;case "list-wps":d(this).addClass("selected"),b.html.list.find(".ibs-list-poi").hide(),b.html.list.find(".ibs-list-seg").hide(),b.html.list.find(".ibs-list-wps").show()}});b.html.search_box.on("keypress","",{},function(a){13===(a.keyCode?a.keyCode:a.which)&&""===b.html.search_box.find(".ibs-pac-input").val()&&b.foundPlaces.forEach(function(a){a.marker.setMap(null)})});b.html.page.append(d("<div>").hide().append(d("<ul>").addClass("ibs-upload-list")).append(d("<div>").addClass("ibs-upload-button").html("Browse")));
b.html.upload_list=b.html.page.find(".ibs-upload-list");b.html.upload_button=b.html.page.find(".ibs-upload-button");this.uploader=b.html.upload_button.fineUploader({listElement:b.html.upload_list,request:{endpoint:this.options.args.url+"lib/server/endpoint.php",params:{dir:b.options.args.libpath+"uploads/"}},debug:!1});this.uploadCount=0;this.uploader.on("submit","",{},function(){this.uploadCount++});this.uploader.on("complete","",{},function(a,c,d,f){b.uploadCount--;a=getExtension(d).toLowerCase();
"kml"!==a&&"kmz"!==a&&"gpx"!==a||b.file.importFile(b.options.args.liburl+"uploads/"+d)});this.upload=function(){b.html.upload_list.empty();var a=b.html.upload_button;a.find("input[qq-button-id]");a.find("input").trigger("click")};d.widget("ui.dialog",d.ui.dialog,{_allowInteraction:function(a){return!!d(a.target).closest(".cke_dialog").length||this._super(a)}});d(window).resize(d.proxy(function(a){this.sizeHtml()},this));window.onbeforeunload=d.proxy(function(a){if(a=this.isDirty())return a},this);
this.html.map.on("click",".ibs-menu-select",{},function(a){a.preventDefault();a=d(this).attr("menu");var c=null;"action"!==a?b.html.action_menu.find(".ibs-action-list").hide():c=b.html.action_menu.find(".ibs-action-list");"control"!==a?b.html.control_menu.find(".ibs-control-list").hide():c=b.html.control_menu.find(".ibs-control-list");"draw"!==a?b.html.draw_menu.find(".ibs-draw-list").hide():c=b.html.draw_menu.find(".ibs-draw-list");"manage"!==a?b.html.manage_menu.find(".ibs-manage-list").hide():
c=b.html.manage_menu.find(".ibs-manage-list");c&&(c.is(":visible")?c.hide():c.show())});this.html.control_menu.on("click",".ibs-control-item",{},function(a){"close"===d(this).attr("action")&&(a.preventDefault(),b.html.control_menu.find(".ibs-control-list").hide())});this.html.control_menu.on("change",".ibs-control-item",{},function(a){a.preventDefault();a=d(this).attr("action");var c=d(this).is(":checked");switch(a){case "distance":b.options.distance=c;break;case "bike-layer":b.setBikeLayer(c);break;
case "traffic-layer":b.setTrafficLayer(c);break;case "transit-layer":b.setTransitLayer(c);break;case "placemarks":b.file.placemarkVisible(c);break;case "waypoints":b.file.waypointVisible(c);break;case "markermanager":b.options.markerManager.set=c;b.file.manageMarkers();break;default:this.html.control_menu.find(".ibs-control-list").hide()}});this.html.action_menu.on("click",".ibs-action-item",{},function(a){a.preventDefault();a=d(this).attr("action");b.html.action_menu.find(".ibs-action-list").hide();
switch(a){case "browse":b.browseDialog();break;case "upload":b.upload();break;case "download":b.file.downloadDialog();break;case "save":b.file.saveDialog();break;case "focus":b.file.focus();break;case "edit":b.file.fileDialog();break;case "flip":b.file.flip();break;case "sort":b.file.pendSort();break;case "clear":b.clear()}});this.html.draw_menu.on("click","a.ibs-draw-item",{},function(a){a.preventDefault();b.html.draw_menu.find(".ibs-draw-list").hide();switch(d(this).attr("action")){case "draw-line":b.file.pendSegment();
break;case "add-poi":b.file.pendPlacemark()}});this.html.draw_menu.on("change","input[type=checkbox]",{},function(a){a.preventDefault();a=d(this).attr("action");var c=d(this).is(":checked");switch(a){case "followroad":b.options.followRoad=c;break;case "avoidhighways":b.options.avoidHighways=c;break;default:b.html.draw_menu.find(".ibs-draw-list").hide()}});this.html.draw_menu.on("change","input[type=radio]",{},function(a){a.preventDefault();b.options.travelMode=d(this).val()});this.html.manage_menu.on("change",
"input.ibs-control-item",{},function(a){a=d(this).attr("action");b.options.args.debug=d(this).is(":checked")?"on":"off";switch(a){case "debug":a={action:"ibs_mappro_index",nonce:b.options.args.nonce,func:"set_debug",debug:d(this).is(":checked")?"on":"off"},d.get(b.options.args.ajax,a).done(function(a,b){"success"===b&&-1===a.indexOf("error")||alert(a)})}});this.html.manage_menu.on("click","a.ibs-manage-item",{},function(a){a.preventDefault();b.html.manage_menu.find(".ibs-manage-list").hide();switch(d(this).attr("action")){case "tracks":new TracksDialog(b);
break;case "remove":new CleanLibraryDialog(b.options.args);break;case "upload":new UploadLibraryDialog(b.options.args);break;case "icons":new IconLibraryDialog(b.options.args);break;default:b.html.manage_menu.find(".ibs-manage-list").hide()}});this.html.route_menu.on("click",".ibs-route-item",{},function(a){a.preventDefault();b.html.route_menu.hide();a=d(this).attr("rel");a=b.file.segments[a];switch(d(this).attr("action")){case "extend":a.extend();break;case "append":a.append();break;case "focus":a.focus();
break;case "ledit":a.lineEdit();break;case "flip":a.flip();break;case "rebuild":a.rebuild();break;case "thin":a.thin();break;case "undo":a.undo();break;case "directions":a.cuesheetDirections();break;case "elevation":a.elevation();break;case "cuesheet":a.cuesheetWaypoints()}});b.html.placemark_dialog.on("click",".ibs-map-icon",{},function(a){a.preventDefault();b.html.placemark_dialog.find(".ibs-placemark-selected-icon").attr("src",d(this).attr("src"))});this.html.map.on("click",".ibs-show-profile",
{},function(a){a.preventDefault();a=d(this).attr("rel");b.file.segments[a].elevation()});this.html.map.on("click",".ibs-show-cuesheet",{},function(a){a.preventDefault();a=d(this).attr("rel");b.file.segments[a].cuesheetWaypoints()});this.html.map.on("click",".ibs-info-modify-placemark",{},function(a){a.preventDefault();b.infowindow.close();a=d(this).attr("rel");switch(d(this).attr("action")){case "edit":b.file.placemarks[a].placemarkDialog();break;case "remove":b.file.placemarks[a].remove()}});this.html.map.on("click",
".ibs-info-modify-segment",{},function(a){a.preventDefault();b.infowindow.close();a=d(this).attr("rel");switch(d(this).attr("action")){case "edit":b.file.segments[a].segmentDialog();break;case "remove":b.file.segments[a].remove();break;case "more":var c=b.html.route_menu;b.setMenuXY(c,b.infowindow.getPosition());c.find(".ibs-route-item").attr("rel",a);c.show()}});b.html.map.on("click",".ibs-search-info-mark",{},function(a){a.preventDefault();a=d(this).attr("rel");a=b.foundPlaces[a];var c="<div>"+
a.details.formatted_address+"</div><div>"+a.details.formatted_phone_number+"</div><div>"+a.details.html_attributions+'</div><div><a href="'+a.details.url+'" target="_blank" >website</a></div>';b.infowindow.close();b.file.addPlacemark({name:a.place.name,desc:c,url:null,symbol:null,position:a.marker.getPosition(),visible:!0})});b.html.prompt_dialog.on("keypress",".ibs-answer",{},function(a){13===(a.keyCode?a.keyCode:a.which)&&(a.preventDefault(),a=b.html.prompt_dialog,a.dialog("option","buttons").Ok.apply(a))});
b.html.list.on("click",".ibs-placemark-item-image",{},function(a){a.preventDefault();a.stopPropagation();b.file.placemarkFilter(this)});b.html.list.on("click",".ibs-placemark-item-name",{},function(a){a.preventDefault();a.stopPropagation();var c=b.file.placemarks[d(this).attr("rel")];c&&(b.html.placemark_cm_info.hide(),b.infowindow.close(),b.file.selectPlacemark(this,a),c.open())});b.html.list.on("mouseover",".ibs-placemark-item-name",{},function(a){a=d(this).attr("rel");if(a=b.file.placemarks[a])a.marker.setVisible(!0),
b.html.placemark_cm_info.find(".ibs-placemark-cm-desc").text(d("<div>").html(a.options.desc).text()),b.html.placemark_cm_info.find(".ibs-placemark-cm-name").text(a.options.name),b.setMenuXY(b.html.placemark_cm_info,a.marker.getPosition()),b.html.placemark_cm_info.show()});b.html.list.on("mouseout",".ibs-placemark-item-name",{},function(a){if(a=b.file.placemarks[d(this).attr("rel")]){var c=b.file.visiblePlacemark||d(this).hasClass("selected")?!0:!1;a.marker.setVisible(c);b.html.placemark_cm_info.hide()}});
b.html.segment_list.on("click","a.ibs-segment-item-name",{},function(a){a.preventDefault();a.stopPropagation();var c=b.file.segments[d(this).attr("rel")];c&&(b.html.segment_cm_info.hide(),b.infowindow.close(),b.file.selectSegment(this,a),d(this).hasClass("selected")?c.open():b.infowindow.close())});b.html.segment_list.on("mouseover","a.ibs-segment-item-name",{},function(a){a=d(this).attr("rel");if(a=b.file.segments[a])b.html.segment_cm_info.find(".ibs-segment-cm-desc").html(a.options.desc),b.html.segment_cm_info.find(".ibs-segment-cm-name").html(a.options.name),
b.setMenuXY(b.html.segment_cm_info,a.marker.getPosition()),b.html.segment_cm_info.show(),google.maps.event.trigger(a.marker,"mouseover")});b.html.segment_list.on("mouseout","a.ibs-segment-item-name",{},function(a){a=d(this).attr("rel");if(a=b.file.segments[a])b.html.segment_cm_info.hide(),google.maps.event.trigger(a.marker,"mouseout")});b.html.list.mousedown(function(a){});b.html.segment_cm_edit.on("click",".ibs-cm-edit-action",{},function(a){a.preventDefault();a=d(this).data().segment;b.html.segment_cm_edit.hide();
switch(d(this).attr("rel")){case "clear":a&&a.stopEditing();break;case "delete":var c=parseInt(d(this).data("index"));a&&a.removePoint(c);break;case "split":a&&(c=parseInt(d(this).data("index")),a.split(c))}});b.html.segment_cm_line.on("click",".ibs-cm-line-action",{},function(a){a.preventDefault();a=d(this).data().segment;b.html.segment_cm_line.hide();switch(d(this).attr("rel")){case "line-edit":a.lineEdit();break;case "waypoint":if(a){var c=parseInt(d(this).data("point"));a.waypoint(c)}break;case "split":a&&
(c=parseInt(d(this).data("point")),a.split(c))}});b.html.segment_dialog.find(".ibs-opacity-val").spinner({spin:function(a,c){b.html.segment_dialog.colorpicker("opacity",c.value)}});b.html.segment_dialog.find(".ibs-opacity-val").on("change",function(a){b.html.segment_dialog.colorpicker("opacity",d(this).val())});b.html.segment_dialog.find(".ibs-width-val").spinner({spin:function(a,c){b.html.segment_dialog.colorpicker("weight",c.value)}});b.html.segment_dialog.find(".ibs-width-val").on("change",function(){b.html.segment_dialog.colorpicker("weight",
d(this).val())});b.html.file_dialog.find(".ibs-opacity-val").spinner({spin:function(a,c){b.html.file_dialog.colorpicker("opacity",c.value)}});b.html.file_dialog.find(".ibs-opacity-val").on("change",function(){b.html.file_dialog.colorpicker("opacity",ui.value)});b.html.file_dialog.find(".ibs-width-val").spinner({spin:function(a,c){b.html.file_dialog.colorpicker("weight",c.value)}});b.html.file_dialog.find(".ibs-width-val").on("change",function(){b.html.file_dialog.colorpicker("weight",d(this).val())});
b.html.file_dialog.on("keypress",".ibs-file-settings-name",{},function(a){13===(a.keyCode?a.keyCode:a.which)&&(a.preventDefault(),a=b.html.file_dialog,a.dialog("option","buttons").Update.apply(a))});b.html.file_dialog.on("change",".ibs-file-name",{},function(a){b.html.file_dialog.find("input[name=file_settings_ext]:radio").trigger("change")});b.html.file_dialog.on("change","input[name=file_ext]:radio",{},function(a){a=b.html.file_dialog.find("input[name=file_ext]:checked").val();var c=b.html.file_dialog.find(".ibs-file-name").val();
3>c.length&&(c+="*");c=getFilename(c)+"."+a;b.html.file_dialog.find(".ibs-file-name").val(c)});b.html.file_dialog.on("click",".ibs-reset-lines",{},function(a){a=b.html.file_dialog.colorpicker("stroke");for(var c in b.file.segments)b.file.segments[c].options.stroke=a,b.file.segments[c].line.setOptions({strokeColor:a.color,strokeWeight:a.weight,strokeOpacity:a.opacity});b.file.setDirty(!0)});b.html.save_dialog.on("keypress",".ibs-save-name",{},function(a){13===(a.keyCode?a.keyCode:a.which)&&(a.preventDefault(),
a=b.html.save_dialog,a.dialog("option","buttons").Save.apply(a))});b.html.save_dialog.on("change",".ibs-save-name",{},function(a){b.html.save_dialog.find('input[name="file_ext"]:radio').trigger("change")});b.html.save_dialog.on("change",".ibs-save-dir",{},function(a){a=b.html.save_dialog.find(".ibs-save-dir").val();a=(a+"/").replace("//","/");b.html.save_dialog.find(".ibs-save-dir").val(a)});b.html.save_dialog.on("change",'input[name="file_ext"]:radio',{},function(a){a=b.html.save_dialog.find('input[name="file_ext"]:checked').val();
var c=b.html.save_dialog.find(".ibs-save-name").val();0===c.length&&(c+="*");c=getFilename(c)+"."+a;b.html.save_dialog.find(".ibs-save-name").val(c)});b.html.download_dialog.on("change",'input[name="file_ext"]:radio',{},function(a){a=b.html.download_dialog.find('input[name="file_ext"]:checked').val();var c=b.html.download_dialog.find(".ibs-save-name").val();0===c.length&&(c+="*");c=getFilename(c)+"."+a;b.html.download_dialog.find(".ibs-save-name").val(c)});b.html.file_dialog.find(".ibs-reset-lines").button({text:!0,
label:"Set Lines",icons:{primary:"ui-icon-arrowreturnthick-1-e"}});this.html.action_menu.find(".ibs-menu-select").trigger("click");this.resetSize=function(){this.sizeHtml()};this.sizeHtml=function(){this.googlemap&&google.maps.event.trigger(this.googlemap,"resize")}}})(jQuery);
