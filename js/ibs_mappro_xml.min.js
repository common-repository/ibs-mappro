function XMLWriter(b,e){b&&(this.encoding=b);e&&(this.version=e)}
(function(){function b(g){for(var e=g.c.length;e--;)"object"==typeof g.c[e]&&b(g.c[e]);g.n=g.a=g.c=null}function e(g,b,d,h){var c=b+"<"+g.n,a=g.c.length,k,m=0;for(k in g.a)c+=" "+k+'="'+g.a[k]+'"';h.push(c+(a?">":" />"));if(a){do if(c=g.c[m++],"string"==typeof c){if(1==a)return h.push(h.pop()+c+"</"+g.n+">");h.push(b+d+c)}else"object"==typeof c&&e(c,b+d,d,h);while(m<a);h.push(b+"</"+g.n+">")}}XMLWriter.prototype={encoding:"ISO-8859-1",version:"1.0",formatting:"indented",indentChar:" ",indentation:2,
newLine:"\n",writeStartDocument:function(b){this.close();this.stack=[];this.standalone=b},writeEndDocument:function(){this.active=this.root;this.stack=[]},writeDocType:function(b){this.doctype=b},writeStartElement:function(b,e){e&&(b=e+":"+b);var d={n:b,a:{},c:[]};this.active?(this.active.c.push(d),this.stack.push(this.active)):this.root=d;this.active=d},writeEndElement:function(){this.active=this.stack.pop()||this.root},writeAttributeString:function(b,e){this.active&&(this.active.a[b]=e)},writeString:function(b){this.active&&
this.active.c.push(b)},writeElementString:function(b,e,d){this.writeStartElement(b,d);this.writeString(e);this.writeEndElement()},writeCDATA:function(b){this.writeString("<![CDATA["+b+"]]\x3e")},writeComment:function(b){this.writeString("\x3c!-- "+b+" --\x3e")},flush:function(){this.stack&&this.stack[0]&&this.writeEndDocument();var b="",l=this.indentation,d="indented"==this.formatting.toLowerCase(),h='<?xml version="'+this.version+'" encoding="'+this.encoding+'"';void 0!==this.standalone&&(h+=' standalone="'+
!!this.standalone+'"');h=[h+" ?>"];this.doctype&&this.root&&h.push("<!DOCTYPE "+this.root.n+" "+this.doctype+">");if(d)for(;l--;)b+=this.indentChar;this.root&&e(this.root,"",b,h);return h.join(d?this.newLine:"")},close:function(){this.root&&b(this.root);this.active=this.root=this.stack=null},getDocument:window.ActiveXObject?function(){var b=new ActiveXObject("Microsoft.XMLDOM");b.async=!1;b.loadXML(this.flush());return b}:function(){return(new DOMParser).parseFromString(this.flush(),"text/xml")}}})();
function KML(){this.options={name:null,desc:null,url:null,position:null,draggable:!1,visible:!1,stroke:{color:"#0000ff",weight:3,opacity:.5},path:[]};this.file=this.kml=null}
(function(b){KML.prototype.writer=function(b){function g(a){for(var b=0;b<d.length;b++)if(a.color===d[b].color&&a.width===d[b].width)return"#"+d[b].id;a.id="LineStyle-"+padLeftStr(d.length+1,3,"0");d.push(a);return"#"+a.id}function l(a){for(var b=0;b<h.length;b++)if(a.icon===h[b].icon)return"#"+h[b].id;a.id="IconStyle-"+padLeftStr(h.length+1,3,"0");h.push(a);return"#"+a.id}var d=[],h=[],c=b.listSegments(),a=b.listPlacemarks(),k;for(k in b.segments){var m=b.segments[k],n=colorKML(m.options.stroke.opacity,
m.options.stroke.color);m.options.style=g({color:n,width:m.options.stroke.weight.toString()})}for(var f in b.placemarks)m=b.placemarks[f],m.options.style=l({icon:m.marker.icon.url});f=new XMLWriter("UTF-8","1.0");f.writeStartDocument();f.writeStartElement("kml");f.writeAttributeString("xmlns","http://www.opengis.net/kml/2.2");f.writeStartElement("Document");f.writeStartElement("name");f.writeCDATA(b.options.name);f.writeEndElement();f.writeElementString("open","1");f.writeStartElement("description");
f.writeCDATA(b.options.desc);f.writeEndElement();for(k=0;k<h.length;k++)f.writeStartElement("Style"),f.writeAttributeString("id",h[k].id),f.writeStartElement("IconStyle"),f.writeStartElement("Icon"),f.writeElementString("href",h[k].icon),f.writeEndElement(),f.writeEndElement(),f.writeEndElement();for(k=0;k<d.length;k++)f.writeStartElement("Style"),f.writeAttributeString("id",d[k].id),f.writeStartElement("LineStyle"),f.writeElementString("color",d[k].color),f.writeElementString("width",d[k].width),
f.writeEndElement(),f.writeStartElement("PolyStyle"),f.writeElementString("color",d[k].color),f.writeEndElement(),f.writeEndElement();f.writeStartElement("Folder");f.writeElementString("name","Placemarks");f.writeElementString("description","placemarks");for(k=0;k<a.length;k++){var m=b.placemarks[a[k]],n=m.options.position.lat().toString(),q=m.options.position.lng().toString();f.writeStartElement("Placemark");f.writeStartElement("name");f.writeCDATA(m.options.name);f.writeEndElement();f.writeStartElement("description");
f.writeCDATA(m.options.desc);f.writeEndElement();f.writeElementString("styleUrl",m.options.style);f.writeStartElement("Point");f.writeElementString("coordinates",q+","+n+",0");f.writeEndElement();f.writeEndElement()}f.writeEndElement();f.writeStartElement("Folder");f.writeElementString("name","Segments");f.writeElementString("description","segment lines");for(k=0;k<c.length;k++){var m=b.segments[c[k]],p="";m.line.getPath().forEach(function(a){p+=a.lng().toString()+","+a.lat().toString()+",0.00000 \n"});
f.writeStartElement("Placemark");f.writeStartElement("name");f.writeCDATA(m.options.name);f.writeEndElement();f.writeStartElement("description");f.writeCDATA(m.options.desc);f.writeEndElement();f.writeElementString("styleUrl",m.options.style);f.writeStartElement("LineString");f.writeElementString("altitudeMode","clampToGround");f.writeElementString("coordinates",p);f.writeEndElement();f.writeEndElement()}f.writeEndElement();f.writeEndElement();f.writeEndElement();f.writeEndDocument();return f.flush()};
KML.prototype.getLineStyle=function(e){var g=b(e).find("color").text();e=b(e).find("width").text();var l=g.substr(0,2),d=g.substr(2,2),h=g.substr(4,2),g=g.substr(6,2);this.options.stroke.color="#"+g+h+d;this.options.stroke.opacity=parseInt(l,16)/256;this.options.stroke.weight=parseInt(e)};KML.prototype.getStyle=function(e){b(e).find("styleUrl").each(b.proxy(function(g,e){var d=b(e).text().substr(1);b(this.kml).find("Style[id="+d+"]").each(b.proxy(function(d,c){b(c).find("LineStyle").each(b.proxy(function(a,
b){this.getLineStyle(b)},this));b(c).find("IconStyle").each(b.proxy(function(a,c){this.options.url=b(c).find("href:first").text()},this))},this))},this));b(e).children("Style").each(b.proxy(function(g,e){b(e).children("LineStyle").each(b.proxy(function(b,e){this.getLineStyle(e)},this));b(e).children("IconStyle").each(b.proxy(function(d,e){this.options.url=b(e).find("href:first").text()},this))},this))};KML.prototype.getLineString=function(e){b(e).children("LineString").each(b.proxy(function(e,l){this.options.path=
[];for(var d=b(l).children("coordinates").text(),d=d.replace(/\n/g," "),d=b.trim(d);0<d.indexOf("  ");)d=d.replace(/  /g," ");for(var d=d.split(" "),h=0;h<d.length;h++){var c=d[h].split(","),a=parseFloat(c[0]),c=parseFloat(c[1]);this.options.path.push(new google.maps.LatLng(c,a))}0<this.options.path.length&&this.file._addSegment(this.options)},this))};KML.prototype.getPoint=function(e){b(e).children("Point").each(b.proxy(function(e,l){var d=b(l).children("coordinates").text(),d=b.trim(d),h=d.split(","),
d=parseFloat(h[0]),h=parseFloat(h[1]);this.options.position=new google.maps.LatLng(h,d);this.options.name&&this.file._addPlacemark(this.options)},this))};KML.prototype.getDocument=function(e){"Track Points"!==getCDATA(b(e).contents("name").text())&&(this.file.options.name||(this.file.options.name=getCDATA(b(e).contents("name").text())),this.file.options.desc||(this.file.options.desc=getCDATA(b(e).contents("description").text())),b(e).children("Placemark").each(b.proxy(function(e,l){this.options.name=
getCDATA(b(l).children("name").text());this.options.desc=getCDATA(b(l).children("description").text());this.getStyle(l);this.getLineString(l);this.getPoint(l)},this)),b(e).children("Folder").each(b.proxy(function(b,e){this.getDocument(e)},this)))};KML.prototype.reader=function(e,g){this.file=g;b(e).children("kml").each(b.proxy(function(e,d){this.kml=d;b(this.kml).children("Document").each(b.proxy(function(b,c){this.getDocument(c)},this));b(this.kml).children("Folder").each(b.proxy(function(b,c){this.getDocument(c)},
this))},this))};KML.prototype.kmlWindow=function(b){window.open("","KML Export "+(new Date).getTime(),"width=800,height=1000").document.write('<textarea id="kml" style="width: 100%; height: 100%">'+b+"</textarea>")}})(jQuery);function GPX(){this.init()}
(function(b){GPX.prototype.init=function(){var e=[{x:0,y:0,z:0,label:"Black"},{x:140,y:0,z:26,label:"DarkRed"},{x:37,y:65,z:23,label:"DarkGreen"},{x:255,y:243,z:128,label:"DarkYellow"},{x:21,y:27,z:84,label:"DarkBlue"},{x:227,y:49,z:157,label:"DarkMagenta"},{x:207,y:236,z:236,label:"DarkCyan"},{x:188,y:198,z:204,label:"LightGray"},{x:80,y:74,z:75,label:"DarkGray"},{x:255,y:0,z:0,label:"Red"},{x:0,y:128,z:0,label:"Green"},{x:255,y:255,z:0,label:"Yellow"},{x:0,y:0,z:255,label:"Blue"},{x:255,y:0,z:255,
label:"Magenta"},{x:0,y:255,z:255,label:"Cyan"},{x:255,y:255,z:255,label:"White"}];color_to_hex=function(b){for(var l in e)if(e[l].label.toLowerCase()===b.toLowerCase())return"#"+hex(e[l].x)+hex(e[l].y)+hex(e[l].z);return color_to_hex("Red")};gpxColor=function(g){g=b("<div>").css("color",g).css("color");var l=g.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);g=l?"#"+hex(l[1])+hex(l[2])+hex(l[3]):g;g=g.replace("#","");g=parseInt(g,16);var l={x:Math.floor(g/65536%256),y:Math.floor(g/256%256),z:Math.floor(g%
256)},d=Infinity;g=-1;for(var h=0,c=0;c<e.length;++c){var a=e[c],k=l,h=Math.abs(a.x-k.x),m=Math.abs(a.y-k.y),a=Math.abs(a.z-k.z),h=Math.sqrt(h*h+m*m+a*a);h<d&&(d=h,g=c)}if(0>g||g>e.length-1)g=0;l=e[g];l="#"+padLeftStr((65536*l.x+256*l.y+l.z).toString(16),6,"0");return{name:e[g].label,value:l}}};GPX.prototype.writer=function(b){var g=b.listPlacemarks(),l=b.listSegments(),d=new google.maps.LatLngBounds;b.getBounds(d);var h=d.getNorthEast(),c=d.getSouthWest(),d=(new Date).toISOString(),a=new XMLWriter("UTF-8",
"1.0");a.writeStartDocument();a.writeStartElement("gpx");a.writeAttributeString("xmlns","http://www.topografix.com/GPX/1/1");a.writeAttributeString("creator","Indian Bend Solutions LLC");a.writeAttributeString("version","1.0");a.writeAttributeString("xmlns:xsi","http://www.w3.org/2001/XMLSchema-instance");a.writeAttributeString("xsi:schemaLocation","http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd");a.writeStartElement("metadata");a.writeStartElement("link");a.writeAttributeString("href",
"http://www.garmin.com");a.writeElementString("text","Garmin International");a.writeEndElement();a.writeElementString("time",d);a.writeStartElement("bounds");a.writeAttributeString("maxlat",c.lat().toString());a.writeAttributeString("maxlon",c.lng().toString());a.writeAttributeString("minlat",h.lat().toString());a.writeAttributeString("minlon",h.lng().toString());a.writeEndElement();a.writeEndElement();if(b.options.gpx.waypoints)for(h=0;h<g.length;h++)c=b.placemarks[g[h]],"Waypoint"===c.options.symbol&&
(a.writeStartElement("wpt"),a.writeAttributeString("lat",c.options.position.lat().toString()),a.writeAttributeString("lon",c.options.position.lng().toString()),a.writeElementString("time",d),a.writeStartElement("name"),a.writeCDATA(c.options.name),a.writeEndElement(),a.writeStartElement("cmt"),a.writeCDATA(c.options.desc),a.writeEndElement(),a.writeStartElement("desc"),a.writeCDATA(c.options.desc),a.writeEndElement(),a.writeElementString("sym",c.options.symbol),a.writeStartElement("extensions"),a.writeStartElement("gpxx:WaypointExtension"),
a.writeAttributeString("xmlns:gpxx","http://www.garmin.com/xmlschemas/GpxExtensions/v3"),a.writeElementString("gpxx:DisplayMode","SymbolAndName"),a.writeEndElement(),a.writeEndElement(),a.writeEndElement());if(b.options.gpx.placemarks)for(h=0;h<g.length;h++)c=b.placemarks[g[h]],"Waypoint"!==c.options.symbol&&(a.writeStartElement("wpt"),a.writeAttributeString("lat",c.options.position.lat().toString()),a.writeAttributeString("lon",c.options.position.lng().toString()),a.writeElementString("time",d),
a.writeStartElement("name"),a.writeCDATA(c.options.name),a.writeEndElement(),a.writeStartElement("cmt"),a.writeCDATA(c.options.desc),a.writeEndElement(),a.writeStartElement("desc"),a.writeCDATA(c.options.desc),a.writeEndElement(),a.writeElementString("sym",c.options.symbol),a.writeStartElement("extensions"),a.writeStartElement("gpxx:WaypointExtension"),a.writeAttributeString("xmlns:gpxx","http://www.garmin.com/xmlschemas/GpxExtensions/v3"),a.writeElementString("gpxx:DisplayMode","SymbolAndName"),
a.writeEndElement(),a.writeEndElement(),a.writeEndElement());if(b.options.gpx.routes)for(h=0;h<l.length;h++){c=b.segments[l[h]];a.writeStartElement("rte");a.writeStartElement("name");a.writeCDATA(c.options.name);a.writeEndElement();a.writeStartElement("desc");a.writeCDATA(c.options.desc);a.writeEndElement();a.writeStartElement("extensions");a.writeStartElement("gpxx:RouteExtension");a.writeAttributeString("xmlns:gpxx","http://www.garmin.com/xmlschemas/GpxExtensions/v3");a.writeElementString("gpxx:IsAutoNamed",
"false");a.writeElementString("gpxx:DisplayColor",gpxColor(c.options.stroke.color).name);a.writeEndElement();a.writeEndElement();g=c.line.getPath().getArray();d=c.findWaypoints();(0===d.length||0!==d[0].index)&&0<g.length&&(c.waypoint(0),d=c.findWaypoints());for(var k=0;k<d.length;k++){c=b.placemarks[d[k].pid];a.writeStartElement("rtept");a.writeAttributeString("lat",d[k].latlng.lat().toString());a.writeAttributeString("lon",d[k].latlng.lng().toString());a.writeStartElement("name");a.writeCDATA(c.options.name);
a.writeEndElement();a.writeStartElement("cmt");a.writeCDATA(c.options.desc);a.writeEndElement();a.writeStartElement("desc");a.writeCDATA(c.options.desc);a.writeEndElement();a.writeElementString("sym","Waypoint");a.writeStartElement("extensions");a.writeStartElement("gpxx:RoutePointExtension");a.writeAttributeString("xmlns:gpxx","http://www.garmin.com/xmlschemas/GpxExtensions/v3");a.writeElementString("gpxx:Subclass","000000000000FFFFFFFFFFFFFFFFFFFFFFFF");for(var c=k<d.length-1?d[k+1].index:g.length-
1,m=d[k].index+1;m<c;m++)a.writeStartElement("gpxx:rpt"),a.writeAttributeString("lat",g[m].lat().toString()),a.writeAttributeString("lon",g[m].lng().toString()),a.writeEndElement();a.writeEndElement();a.writeEndElement();a.writeEndElement()}a.writeEndElement()}if(b.options.gpx.waypoints){a.writeStartElement("trk");for(var n in b.segments)c=b.segments[n],a.writeStartElement("trkseg"),a.writeStartElement("extensions"),a.writeStartElement("gpxx:TrackExtension"),a.writeAttributeString("xmlns:gpxx","http://www.garmin.com/xmlschemas/GpxExtensions/v3"),
a.writeElementString("gpxx:DisplayColor",gpxColor(c.options.stroke.color).name),a.writeEndElement(),a.writeEndElement(),a.writeStartElement("name"),a.writeCDATA(c.options.name),a.writeEndElement(),a.writeStartElement("desc"),a.writeCDATA(c.options.desc),a.writeEndElement(),c.line.getPath().forEach(function(b){a.writeStartElement("trkpt");a.writeAttributeString("lat",b.lat().toString());a.writeAttributeString("lon",b.lng().toString());a.writeEndElement()}),a.writeEndElement();a.writeEndElement()}a.writeEndElement();
a.writeEndDocument();return a.flush()};GPX.prototype.reader=function(e,g){b(e).children("gpx").each(b.proxy(function(e,d){g.options.desc=b(d).attr("creator");b(d).children("wpt").each(b.proxy(function(d,c){var a={url:"",symbol:null,name:null,desc:null,position:null,daraggable:!1,visible:!1};a.name=getCDATA(b(c).find("name").text());a.cmt=getCDATA(b(c).find("cmt").text());a.desc=getCDATA(b(c).find("desc").text());a.symbol=b(c).find("sym").text();a.position=new google.maps.LatLng(parseFloat(b(c).attr("lat")),
parseFloat(b(c).attr("lon")));g._addPlacemark(a)},this));b(d).children("rte").each(function(d,c){var a={path:[],stroke:{color:"#0000ff",opacity:.7,weight:5},name:"",desc:""};a.name=getCDATA(b(c).find("name:first").text());a.cmt=getCDATA(b(c).find("cmt:first").text());a.desc=getCDATA(b(c).find("desc:first").text());b(c).children("extensions").each(function(c,d){b(d).children().each(function(c,d){"gpxx:RouteExtension"===d.nodeName&&b(d).children().each(function(c,d){"gpxx:DisplayColor"===d.nodeName&&
(a.stroke.color=color_to_hex(b(d).text()))})})});b(c).children("rtept").each(function(d,c){var e=new google.maps.LatLng(parseFloat(b(c).attr("lat")),parseFloat(b(c).attr("lon")));a.path.push(e);b(c).children("extensions").each(function(c,d){b(d).children().each(function(c,d){"gpxx:RoutePointExtension"===d.nodeName&&b(d).children().each(function(d,c){"gpxx:rpt"===c.nodeName&&a.path.push(new google.maps.LatLng(parseFloat(b(c).attr("lat")),parseFloat(b(c).attr("lon"))))})})})});1<a.path.length&&g._addSegment(a)});
b(d).children("trk").each(function(d,c){b(c).children("trkseg").each(function(a,c){var d={path:[],stroke:{color:"#0000ff",opacity:.7,weight:5},name:"track"+a,desc:""},e=b(c).find("name:first").text();d.name="undefined"===typeof e||""===e?"track-"+(a+1):e;d.cmt=getCDATA(b(c).find("cmt:first").text());d.desc=getCDATA(b(c).find("desc:first").text());b(c).children("extensions").each(function(a,c){b(c).children().each(function(a,c){"gpxx:TrackExtension"===c.nodeName&&b(c).children().each(function(a,c){"gpxx:DisplayColor"===
c.nodeName&&(d.stroke.color=color_to_hex(b(c).text()))})})});b(c).children("trkpt").each(function(a,c){var e=new google.maps.LatLng(parseFloat(b(c).attr("lat")),parseFloat(b(c).attr("lon")));d.path.push(e)});g._addSegment(d)})})},this))}})(jQuery);
