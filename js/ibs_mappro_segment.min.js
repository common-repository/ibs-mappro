function Segment(e,c){this.run(e,c)}
(function(e){Segment.prototype.run=function(c,p){this.options={fid:null,sid:null,path:[],stroke:{color:"#000fff",weight:5,opacity:.3},name:null,desc:null,cuesheet:null};this.options=p;this.segmentItem='.ibs-segment-item-name[rel="'+this.options.sid+'"]';this.selected=!1;this.undoStack=[];this.points=[];this.directionsService=this.directionsRenderer=this.markerManager=null;this.editing=!1;this.isActive=!0;this.pend=null;this.click=function(a){switch(this.pend){case "extend":this.addPoint(a.latLng),!1===
c.html.list.find(this.segmentItem).hasClass("selected")&&c.file.selectSegment(c.html.list.find(this.segmentItem)[0]),c.setClick({sid:this.options.sid})}};this.extend=function(){c.setClick({sid:this.options.sid,pid:null});this.pend="extend"};this.lineOptions=function(){return{path:this.options.path,strokeWeight:this.options.stroke.weight,strokeColor:this.options.stroke.color,strokeOpacity:this.options.stroke.opacity}};this.append=function(){c.file.append(this)};this.elevation=function(){c.elevation(c,
this)};this.copy=function(){var a={},b;for(b in this.options)"path"!==b&&(a[b]=this.options[b]);a.latlngs=[];this.line.getPath().forEach(function(b){a.latlngs.push({lat:b.lat(0),lng:b.lng()})});a.sid=this.options.sid;return a};this.distanceTo=function(a){var b=0;a=a.getPosition();var c=this.points[0].getPosition();if(c.equals(a))return 0;for(var f=1;f<this.points.length;f++){var g=this.points[f].getPosition(),b=b+distanceFrom(c,g),c=g;if(a.equals(g))break}return b};this.nearestPoint=function(a){var b=
0,c=null,f=null,g=0,k=0,l=this.line.getPath();l.forEach(e.proxy(function(k,e){b=distanceFrom(k,a);if(null===c||b<c)f=k,g=e,c=b},this));for(var m=null,h=null,n=0;n<l.getLength();n++)if(h=l.getAt(n),0<n&&(k+=distanceFrom(m,h)),m=h,h.equals(f)){k+=c;break}return{latLng:f,index:g,distance:k}};this.distance=function(){return pathLength(this.line.getPath())};this.refresh=function(){var a=this.line.getPath().getAt(this.line.getPath().length-1);this.marker.setPosition(a)};this.remove=function(){this.stopEditing();
this.line.setMap(null);this.marker.setMap(null);this.distanceMarker.setMap(null);this.removeWaypoints();c.html.list.find(this.segmentItem).parent().remove();c.file.removeSegment(this.options.sid)};this._midPoint=function(a,b){return new google.maps.LatLng(b.lat()-.5*(b.lat()-a.lat()),b.lng()-.5*(b.lng()-a.lng()))};this.midPoint=function(a,b){var d=this.line.getPath(),f=d.getAt(a.index-1),d=d.getAt(a.index),f=this._midPoint(f,d),f=new google.maps.Marker({position:f,map:c.googlemap,icon:c.imageNormalMidpoint,
draggable:!0,segment:this,index:b,point:a});google.maps.event.addListener(f,"mouseover",function(){this.setIcon(c.imageNormal);var a=c.distanceTo(this.point)-distanceFrom(this.getPosition(),this.point.getPosition());this.title=c.convertMeters2(Math.round(100*a)/100)+c.measure2()});google.maps.event.addListener(f,"mouseout",function(){this.setIcon(c.imageNormalMidpoint)});google.maps.event.addListener(f,"dragend",function(){var a=this.getPosition(),b=this.point.index;this.segment.line.getPath().insertAt(b,
a);var c=this.segment.point(a,b);this.segment.points.splice(b,0,c);for(var d in this.segment.points)this.segment.points[d].index=parseInt(d);b=this.point.getPosition();this.setPosition(this.segment._midPoint(a,b))});return f};this.point=function(a,b){var d=new google.maps.Marker({position:a,map:c.googlemap,icon:c.imageNormal,draggable:!0,index:b,segment:this,midpoint:null});d.midpoint=0<b?this.midPoint(d,b):null;google.maps.event.addListener(d,"mouseover",function(a){this.setIcon(c.imageHover);a=
this.segment.distanceTo(this);this.setTitle(c.convertMeters2(Math.round(100*a)/100)+c.measure2())});google.maps.event.addListener(d,"mouseout",function(){this.setIcon(c.imageNormal)});google.maps.event.addListener(d,"drag",function(){this.segment.line.getPath().setAt(this.index,this.getPosition());this.segment.refresh()});google.maps.event.addListener(d,"dragend",function(){var a=this.segment.line.getPath();a.setAt(this.index,this.getPosition());var b=null===this.midpoint||0===this.index?this.segment.points[1]:
this;if(2<=this.segment.points.length){var c=a.getAt(b.index-1),d=a.getAt(b.index);b.midpoint.setPosition(midPoint(c,d));c=parseInt(b.index)+1;c<this.segment.points.length&&(b=this.segment.points[c],c=a.getAt(b.index-1),d=a.getAt(b.index),b.midpoint.setPosition(midPoint(c,d)))}this.segment.refresh()});google.maps.event.addListener(d,"click",function(a){this.segment.contextMenuLineEdit(this.index)});return d};this.followRoad=function(a){var b=this,d={avoidHighways:c.options.avoidHighways,origin:this.line.getPath().getAt(this.line.getPath().getLength()-
1),destination:a,travelMode:google.maps.DirectionsTravelMode[c.options.travelMode]};c.directionsService.route(d,function(c,d){if(d===google.maps.DirectionsStatus.OK)for(var e in c.routes)for(a in c.routes[e].overview_path)b.line.getPath().push(c.routes[e].overview_path[a]);b.refresh()})};this.addPoint=function(a){this.save();this.stopEditing();c.options.followRoad?this.followRoad(a):this.line.getPath().push(a);this.refresh();c.file.setDirty(!0)};this.rebuild=function(){var a=this.line.getPath();this.save();
var b=a.getLength(),d=a.getAt(0),a=a.getAt(b-1);this.stopEditing();this.line.setPath([d]);this.addPoint(a);this.undoStack.pop();c.infowindow.close()};this.waypoint=function(a){var b=this.line.getPath();0<=a&&b.getLength()&&(options={waypoint:!0,position:b.getAt(a),draggable:!1,symbol:"Waypoint",url:"",visible:!0,pid:null},c.file.addPlacemark(options))};this.split=function(a){var b={path:[],strokeColor:this.line.strokeColor,strokeOpacity:this.line.strokeOpacity,strokeWeight:this.line.strokeWeight,
name:this.options.name+".",desc:this.options.desc},d=this.line.getPath();if(0<a&&1<d.getLength()){for(this.stopEditing();a<=d.getLength()-1;)b.path.push(d.getAt(a)),d.removeAt(a);c.file.addSegment(b);this.refresh();c.file.setDirty(!0);c.setClick(null)}};this.thin=function(){var a=this.line.getPath();this.save();var b=[],d=null;a.forEach(e.proxy(function(a,c){d?300<distanceFrom(d,a)&&(b.push(a),d=a):d=a},this));a=a.getLength();a-=b.length;this.line.setPath(b);c.notice("dropped "+a+" points.");c.file.setDirty(!0)};
this.save=function(){var a=[];this.line.getPath().forEach(function(b,c){a.push(b)});this.undoStack.push(a)};this.undo=function(){if(this.undoStack.length){this.stopEditing();var a=this.undoStack.pop();this.line.setPath(a);this.refresh()}};this.flip=function(){var a=this.line.getPath();this.save();for(var b=[],c=a.getLength();0<c;c--)b.push(a.pop());this.line.setPath(b);this.refresh()};this.getBounds=function(a){this.line.getPath().forEach(function(b,c){a.extend(b)})};this.focus=function(){var a=new google.maps.LatLngBounds;
this.getBounds(a);c.googlemap.fitBounds(a)};this.manageMarkers=function(){this.markerManager&&this.markerManager.clearMarkers();this.marker_cluster=[];for(var a in this.points)this.marker_cluster.push(this.points[a]),this.points[a].midpoint&&this.marker_cluster.push(this.points[a].midpoint);this.markerManager=new MarkerClusterer(c.googlemap,this.marker_cluster,{gridSize:50})};this.stopEditing=function(){this.markerManager&&this.markerManager.clearMarkers();for(var a in this.points)this.points[a].setMap(null),
null!==this.points[a].midpoint&&this.points[a].midpoint.setMap(null);this.points.length=0;this.editing=!1};this.lineEdit=function(){var a=this;if(this.editing)this.stopEditing();else{if(0===this.points.length)this.line.getPath().forEach(function(b,c){var g=a.point(b,c);a.points.push(g)}),this.manageMarkers();else for(var b in this.points)this.points[b].setVisible(!0),null!==this.points[b].midpoint&&this.points[b].midpoint.setVisible(!0);this.editing=!0}};this.open=function(){c.file.openInfo(this)};
this.contextMenuLine=function(a){var b=c.html.segment_cm_line;b.find(".ibs-cm-line-action").data({segment:this,point:a.index});c.setMenuXY(b,a.latLng);b.show()};this.contextMenuLineEdit=function(a){var b=c.html.segment_cm_edit;b.find(".ibs-cm-edit-action").data({segment:this,index:a});c.setMenuXY(b,this.line.getPath().getAt(a));b.show()};this.contextMenuMarker=function(a){var b=c.html.segment_cm_marker;b.find(".ibs-cm-marker-action").data({segment:this});c.setMenuXY(b,a);b.show()};this.removePoint=
function(a){if(this.points.length){var b=this.points[a],c=this.line.getPath();if(1<c.getLength()){this.save();b.setMap(null);null!==b.midpoint&&b.midpoint.setMap(null);c.removeAt(a);this.points.splice(a,1);for(var f in this.points)this.points[f].index=parseInt(f);a<this.points.length&&0<a&&(b=this.points[a-1].getPosition(),c=this.points[a].getPosition(),this.points[a].midmarker.setPosition(midPoint(b,c)));this.refresh();this.parent.setDirty(!0)}}};this.getDirRenderOptions=function(a){var b={draggable:!0,
map:null,markerOptions:{},polylineOptions:{strokeColor:"#ff0000",strokeWeight:3,strokeOpacity:1},preserveViewport:!1,suppressBicyclingLayer:!1,suppressInfoWindows:!0,suppressMarkers:!1,suppressPolylines:!1},c;for(c in a)b[c]=a[c];return b};this.cuesheetKill=function(){this.directionsRenderer&&this.directionsRenderer.getMap()&&this.directionsRenderer.setMap(null)};this.metersToStr=function(a,b){return{d:Math.round10(b?a/1E3:a/1609.344,-1),m:b?"km":"mi"}};this.cueLine=function(a){var b=this.metersToStr(a.distance,
a.metric);return"<div><label>"+b.d+"  "+b.m+" :: </label><span>"+a.instructions+"</span></div>"};this.cuesheetDirections=function(){var a=this;if(this.directionsRenderer&&this.directionsRenderer.getMap())this.cuesheetKill();else{this.directionsService||(this.directionsService=new google.maps.DirectionsService);this.directionsRenderer||(this.directionsRenderer=new google.maps.DirectionsRenderer(this.getDirRenderOptions({})),this.directionsRenderer.setPanel(c.html.cuesheet_dialog.find(".ibs-cuesheet")[0]),
google.maps.event.addListener(this.directionsRenderer,"directions_changed",function(){}));var b=this.line.getPath(),d=b.getAt(0),b=b.getAt(b.getLength()-1);options={origin:d,destination:b,travelMode:c.options.travelMode,transitOptions:{},unitSystem:c.options.metric?google.maps.UnitSystem.METRIC:google.maps.UnitSystem.IMPERIAL,durationInTraffic:!1,waypoints:[],optimizeWaypoints:!1,provideRouteAlternatives:!1,avoidHighways:c.options.avoidHighways,avoidTolls:!0};this.cuesheetDialog();this.directionsService.route(options,
function(b,d){d===google.maps.DirectionsStatus.OK?(a.directionsRenderer.setMap(c.googlemap),a.directionsRenderer.setDirections(b)):a.options.map.alert(d)})}};this.findWaypoints=function(){var a=[],b;for(b in c.file.placemarks){var d=c.file.placemarks[b];if("Waypoint"===d.options.symbol)for(var d=d.options.position,f=this.line.getPath().getArray(),e=0;e<f.length;e++)if(d.equals(f[e])){a.push({pid:b,latlng:d,index:e});break}}a.sort(function(a,b){return a.index-b.index});return a};this.copyWaypoints=
function(a){for(var b=this.findWaypoints(),d=0;d<b.length;d++)a.push(c.file.placemarks[b[d].pid].copy())};this.removeWaypoints=function(){for(var a=this.findWaypoints(),b=0;b<a.length;b++)c.file.placemarks[a[b].pid].remove()};this.cueUpdateWaypoints=function(a){for(var b={url:"",symbol:"Waypoint",name:null,desc:null,position:null,visible:!0},d=0,e=null,g=0,k=0;k<a.legs.length;k++){e=a.legs[k];b.position=this.nearestPoint(e.start_location).latLng;b.desc="Start - "+e.start_address;b.name=this.options.sid+
" 1000";c.file.addPlacemark(b);for(var l={type:"waypoint"},m=0;m<e.steps.length;m++){var h=e.steps[m];l.distance=d;l.step=g;l.instructions=h.instructions;b.desc=this.cueLine(l);b.position=this.nearestPoint(h.start_location).latLng;b.name=this.options.sid+" "+(m+1001);c.file.addPlacemark(b);h.distance&&(g=h.distance.value,d+=h.distance.value)}l.distance=d;l.step=g;l.instructions=e.end_address;b.desc=this.cueLine(l);b.position=this.nearestPoint(e.end_location).latLng;b.name=this.options.sid+" "+(m+
1002);c.file.addPlacemark(b)}};this.cueUpdatePath=function(){if(this.directionsRenderer&&this.directionsRenderer.getMap()){this.removeWaypoints();var a=this.directionsRenderer.getDirections().routes[0];this.line.setPath(a.overview_path);this.cueUpdateWaypoints(a);this.options.cuesheet=c.html.cuesheet_dialog.find(".ibs-cuesheet").html();c.file.setDirty(!0);this.refresh()}};this.edit=function(){this.segmentDialog()};this.segmentDialog=function(){var a=c.html.segment_dialog,b=c.getCkeditorConfig();a.find(".ibs-segment-dialog-sid").val(this.options.sid);
a.find(".ibs-segment-dialog-desc").val(this.options.desc);a.find(".ibs-segment-dialog-name").val(this.options.name);a.colorpicker("stroke",this.options.stroke);a.find(".ibs-segment-dialog-stats").html(" miles="+c.convertMeters2(this.distance()).toString()+" points: "+this.line.getPath().getLength());setCurrentColor(a);a.dialog({autoOpen:!0,width:600,modal:!0,buttons:{Update:e.proxy(function(){a.find(".ibs-colorpicker-trigger");this.options.stroke=a.colorpicker("stroke");this.options.name=a.find(".ibs-segment-dialog-name").val();
this.options.desc=a.find(".ibs-segment-dialog-desc").val();this.line.setOptions({strokeColor:this.options.stroke.color,strokeOpacity:this.options.stroke.opacity,strokeWeight:this.options.stroke.weight});c.file.setDirty(!0);c.html.segment_list.find(this.segmentItem).html(this.options.name);a.dialog("close")},this),Close:function(){e(this).dialog("close")}},open:function(){a.find(".ibs-segment-dialog-desc").ckeditor(b);a.find(".ibs-segment-dialog-desc").ckeditor().resize("100%","100%",!1);a.find(".ibs-segment-dialog-desc").ckeditor().editor.mappro=
c},close:function(){a.find(".ibs-segment-dialog-desc").ckeditorGet().destroy();e(this).dialog("destroy")},resize:function(b){a.find(".ibs-segment-dialog-desc").ckeditor().resize("100%","100%",!1)}})};this.cuesheetDialog=function(){c.html.cuesheet_dialog.find(".ibs-cuesheet").empty();var a=c.html.cuesheet_dialog;a.dialog({autoOpen:!0,draggable:!0,position:{my:"left top",at:"left top",of:c.html.page.find(".ibs-list")},width:400,height:400,modal:!1,buttons:{Print:function(){a.find(".ibs-cuesheet").print()},
Finish:e.proxy(function(){this.cueUpdatePath();a.dialog("close")},this),Cancel:e.proxy(function(){a.dialog("close")},this)},open:function(){this.isActive=!1},close:e.proxy(function(){this.isActive=!0;this.directionsRenderer&&this.directionsRenderer.getMap()&&this.directionsRenderer.setMap(null);this.cuesheetKill()},this)})};this.setSegmentItem=function(){var a=this.options.sid,b=e("<div>").html(this.options.desc).contents().filter(function(){return!!e.trim(this.innerHTML||this.data)}).first(),b="<label>"+
this.options.name+"</label><div>"+e(b).text().slice(0,300)+"</div>",a=e("<li>").addClass("ibs-segment-item").attr({rel:a}).append(e("<img>").addClass("ibs-segment-item-image").css({height:"18px"}).attr({rel:a,alt:"image",src:c.options.args.url+"image/line.png"})).append(e("<a>").addClass("ibs-segment-item-name name").attr({rel:a,href:"#",title:""}).html(b));c.html.segment_list.append(e(a))};this.setSegmentItem();this.line=new google.maps.Polyline(this.lineOptions());this.line.setMap(c.googlemap);
this.line.segment=this;this.marker=new google.maps.Marker({position:this.options.path[0],map:c.googlemap,title:this.options.name,icon:c.imageSegmentEnd,segment:this});this.distanceMarker=new google.maps.Marker({position:this.options.path[0],map:c.googlemap,visible:!1,icon:c.imageDistancePointer});google.maps.event.addListener(this.marker,"click",e.proxy(function(a){this.isActive&&c.html.list.find(this.segmentItem).trigger("click")},this));google.maps.event.addListener(this.line,"mouseover",e.proxy(function(a){if(!this.editing&&
this.isActive&&c.options.distance&&!c.html.distance_info.is(":visible")){var b=this.nearestPoint(a.latLng),d=c.convertMeters2(b.distance)+c.measure2();this.distanceMarker.setPosition(b.latLng);this.distanceMarker.index=b.index;this.distanceMarker.setVisible(!0);this.distanceMarker.setTitle("");c.html.distance_info.text(d);c.setMenuXY(c.html.distance_info,a.latLng,0,-40);c.html.distance_info.show()}},this));google.maps.event.addListener(this.line,"mouseout",e.proxy(function(a){var b=c.html.distance_info;
if(this.isActive)var d=setInterval(e.proxy(function(){clearInterval(d);b.hide();this.distanceMarker.setVisible(!1)},this),1E3)},this));google.maps.event.addListener(this.marker,"mouseover",e.proxy(function(a){this.isActive&&this.line.setOptions({strokeWeight:this.options.stroke.weight+4})},this));google.maps.event.addListener(this.marker,"mouseout",e.proxy(function(a){this.isActive&&this.line.setOptions({strokeWeight:this.options.stroke.weight})},this));google.maps.event.addListener(this.marker,"rightclick",
e.proxy(function(a){this.isActive&&c.options.args.admin&&!c.html.route_menu.is(":visible")&&(a=c.html.route_menu,c.setMenuXY(a,this.marker.getPosition()),a.find(".ibs-route-item").attr("rel",this.options.sid),a.show())},this));google.maps.event.addListener(this.line,"click",e.proxy(function(a){this.isActive&&(a=this.nearestPoint(a.latLng),this.distanceMarker.setPosition(a.latLng),this.contextMenuLine(a))},this));this.refresh();Segment.prototype.cuesheetWaypoints=function(){this.cuesheetDialog();for(var a=
this.line.getPath(),b=c.options.metric,d=0,f=0,g,k=this.findWaypoints(),l=e("<table>"),m=0;m<k.length;m++){g=c.file.placemarks[k[m].pid].options.desc;var f=f+d,d=0,h=k[m].index;if(m<k.length-1){var n=-1!==g.indexOf(":")?":":null;if(n=-1!==g.indexOf("::")?"::":n)g=g.split(n),g='<tr><td style="width:100px; text-wrap:normal; text-align:right">'+g[0]+'<td><td style="padding:5px; width:400px; text-wrap:normal;">'+g[1]+"</td></tr>",l.append(g);else{for(n=k[m+1].index;h!==n&&h!==a.length;){try{d+=distanceFrom(a.getAt(h),
a.getAt(h+1))}catch(p){d=0}h++}""!==g&&(h=this.metersToStr(f,b),g='<tr><td style="text-align:right">'+h.d+"  "+h.m+'<td><td style="padding:5px; width:400px; text-wrap:normal;">'+g+"</td></tr>",l.append(g))}}}c.html.cuesheet_dialog.find(".ibs-cuesheet").empty();c.html.cuesheet_dialog.find(".ibs-cuesheet").append(l).prepend(e("<div>").text(this.options.name))}}})(jQuery);
