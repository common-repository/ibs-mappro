(function(h){IBS_MAPPRO.prototype.elevation=function(f,l){this.getElevations=function(a){var d=0,b=[];a=a.line.getPath();for(var c=0;c<a.length;c++)c&&(d+=distanceFrom(a.getAt(c-1),a.getAt(c))),b.push({latlng:a.getAt(c),distance:d});a=d/1609/5;c=Math.floor(Math.log(a)/2.302585092994046);c=Math.pow(10,c);a=Math.floor(a/c);a=(5<a?10:2<a?5:2)*c;a=1609*a*Math.ceil(d/1609/a)/750;c=[];c.push(b[0].latlng);for(var g=1,e=0;750>g&&g*a<=d;){for(;g*a>b[e+1].distance;)e++;var f=(g*a-b[e].distance)/(b[e+1].distance-
b[e].distance);try{c.push(google.maps.geometry.spherical.interpolate(b[e].latlng,b[e+1].latlng,f))}catch(h){alert("geometry(?) threw error: "+h+"\n\nArgument to interpolate: "+b[e].latlng+","+b[e+1].latlng+","+f+"\npIndex: "+e);for(var f="",k=e-10;e+10>k;k++)f=f+k+"-"+b[k].latlng+"| ";alert(f)}g++}c.push(b[b.length-1].latlng);this.getElevationParts(c,0)};this.getElevationParts=function(a,d){var b=250<a.length?a.slice(0,250):a;a=250<a.length?a.slice(250):[];this.elevationService.getElevationForLocations({locations:b},
h.proxy(function(c,b){b!==google.maps.ElevationStatus.OK?alert("received status "+b):(this.elevations=this.elevations.concat(c),d+=c.length,0<a.length?this.getElevationParts(a,d):this.showElevationChart())},this))};this.showElevationChart=function(){var a=new google.visualization.DataTable;a.addColumn("string","Sample");a.addColumn("number","Elevation");var d=0;for(i=0;i<this.elevations.length;i++){if(0<i&&this.elevations[i].elevation>this.elevations[i-1].elevation){var b=parseFloat(this.convertMeters1(this.elevations[i].elevation)),
c=parseFloat(this.convertMeters1(this.elevations[i-1].elevation));this.elevations[i].gain=b-c;d+=b-c}else this.elevations[i].gain=0;a.addRow(["",parseFloat(this.convertMeters1(this.elevations[i].elevation))])}b="Elevation "+this.measure1();this.elevationChart.draw(a,{legend:"none",titleY:b,focusBorderColor:"#00ff00",backgroundColor:"white",colors:["Blue"],tooltipTextStyle:{visibility:"hidden"}});this.elevationChart.setSelection([{row:0,col:1}]);f.html.map_data.find(".ibs-data-segment").html("<strong>Segment:</strong> "+
this.elevationSegment.options.name);f.html.map_data.find(".ibs-data-distance").html("<strong>Distance:</strong> "+this.convertMeters2(this.elevationSegment.distance())+this.measure2());f.html.map_data.find(".ibs-data-gain").html("<strong>Climbing:</strong> "+d.toFixed(2)+this.measure1())};this.infowindow.close();this.selectedPoint=null;this.elevationSegment=l;try{l.focus()}catch(m){this.elevationSegment=null;return}this.elevationService=new google.maps.ElevationService;this.elevationChart=new google.visualization.AreaChart(f.html.map_data_chart[0]);
this.elevations=[];google.visualization.events.addListener(this.elevationChart,"onmouseout",h.proxy(function(a){this.elevationSegment&&(f.html.distance_info.hide(),this.elevationSegment.distanceMarker.setVisible(!1))},this));google.visualization.events.addListener(this.elevationChart,"onmouseover",h.proxy(function(a){for(var d=this.elevationSegment.nearestPoint(this.elevations[a.row].location),b=0,c=this.selectedPoint?this.selectedPoint:0,g=a.row,e=c<g?c:g,c=e===c?g:c;e<c;e++)b+=parseFloat(this.elevations[e].gain);
e=d.distance;this.selectedPoint&&(d=this.elevationSegment.nearestPoint(this.elevations[this.selectedPoint].location),e=e<d.distance?d.distance-e:e-d.distance);d=this.convertMeters2(e);d+=this.measure2();f.html.distance_info.html(d+" total gain "+b.toFixed(2)+this.measure1());this.setMenuXY(f.html.distance_info,this.elevations[a.row].location);b=parseInt(f.html.distance_info.css("top").replace(/px/,""));f.html.distance_info.css("top",b-35+"px");f.html.distance_info.show();this.elevationSegment.distanceMarker.setPosition(this.elevations[a.row].location);
this.elevationSegment.distanceMarker.setVisible(!0)},this));google.visualization.events.addListener(this.elevationChart,"select",h.proxy(function(a){a=this.elevationChart.getSelection();0<a.length&&a[0].row&&(this.selectedPoint=a[0].row)},this));this.getElevations(l)}})(jQuery);
